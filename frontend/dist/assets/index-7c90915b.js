import{r as t,a as we,R as Le}from"./vendor-b1791c80.js";(function(){const h=document.createElement("link").relList;if(h&&h.supports&&h.supports("modulepreload"))return;for(const N of document.querySelectorAll('link[rel="modulepreload"]'))f(N);new MutationObserver(N=>{for(const S of N)if(S.type==="childList")for(const c of S.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&f(c)}).observe(document,{childList:!0,subtree:!0});function g(N){const S={};return N.integrity&&(S.integrity=N.integrity),N.referrerPolicy&&(S.referrerPolicy=N.referrerPolicy),N.crossOrigin==="use-credentials"?S.credentials="include":N.crossOrigin==="anonymous"?S.credentials="omit":S.credentials="same-origin",S}function f(N){if(N.ep)return;N.ep=!0;const S=g(N);fetch(N.href,S)}})();var ke={exports:{}},Ne={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Fe=t,Pe=Symbol.for("react.element"),Ie=Symbol.for("react.fragment"),Be=Object.prototype.hasOwnProperty,He=Fe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ge={key:!0,ref:!0,__self:!0,__source:!0};function Me(l,h,g){var f,N={},S=null,c=null;g!==void 0&&(S=""+g),h.key!==void 0&&(S=""+h.key),h.ref!==void 0&&(c=h.ref);for(f in h)Be.call(h,f)&&!Ge.hasOwnProperty(f)&&(N[f]=h[f]);if(l&&l.defaultProps)for(f in h=l.defaultProps,h)N[f]===void 0&&(N[f]=h[f]);return{$$typeof:Pe,type:l,key:S,ref:c,props:N,_owner:He.current}}Ne.Fragment=Ie;Ne.jsx=Me;Ne.jsxs=Me;ke.exports=Ne;var s=ke.exports,Ee={},Te=we;Ee.createRoot=Te.createRoot,Ee.hydrateRoot=Te.hydrateRoot;function We({onSongSelect:l,apiBase:h}){var d,R,b,x,$,I,J;const[g,f]=t.useState([]),[N,S]=t.useState(!0),[c,p]=t.useState(null);t.useEffect(()=>{O()},[]);const O=async()=>{try{const o=await(await fetch(`${h}/library`)).json();f(o)}catch(n){console.error("Failed to load library:",n)}finally{S(!1)}},P=async n=>{try{const o=await fetch(`${h}/library/${n.id}`);if(!o.ok){const k=await o.json().catch(()=>({}));console.error("Failed to load song details:",k.error||o.statusText),alert(`Failed to load song: ${k.error||o.statusText}`);return}const a=await o.json();p(a),l(a)}catch(o){console.error("Failed to load song details:",o),alert(`Failed to load song: ${o.message}`)}},q=n=>new Date(n).toLocaleDateString();return N?s.jsx("div",{className:"library-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"LOADING LIBRARY..."})]})}):s.jsxs("div",{className:"library-container",children:[s.jsxs("div",{className:"library-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸŽµ SONG LIBRARY ðŸŽµ"}),s.jsx("div",{className:"library-controls",children:s.jsx("button",{className:"retro-button",onClick:O,children:"ðŸ”„ REFRESH"})})]}),s.jsx("div",{className:"library-content",children:g.length===0?s.jsxs("div",{className:"empty-library",children:[s.jsx("h2",{children:"ðŸŽ¤ NO SONGS IN LIBRARY"}),s.jsx("p",{children:"Place preprocessed references and videos to get started."})]}):s.jsx("div",{className:"songs-grid",children:g.map(n=>s.jsxs("div",{className:`song-card ${(c==null?void 0:c.id)===n.id?"selected":""}`,onClick:()=>P(n),children:[s.jsxs("div",{className:"song-info",children:[s.jsx("h3",{className:"song-title",children:n.name}),s.jsxs("p",{className:"song-date",children:["Added: ",q(n.uploaded_at)]}),s.jsx("div",{className:"song-status",children:s.jsx("span",{className:"status-badge ready",children:"âœ… READY"})})]}),s.jsx("div",{className:"song-actions",children:s.jsx("button",{className:"retro-button small",onClick:o=>{o.stopPropagation(),P(n)},children:"ðŸŽ¤ SING"})})]},n.id))})}),c&&s.jsxs("div",{className:"song-details",children:[s.jsxs("h3",{children:["Selected: ",c.name]}),s.jsxs("div",{className:"song-metadata",children:[s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Duration:"}),s.jsxs("span",{className:"value",children:[(R=(d=c.reference_data)==null?void 0:d.duration)==null?void 0:R.toFixed(1),"s"]})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Tempo:"}),s.jsxs("span",{className:"value",children:[(x=(b=c.reference_data)==null?void 0:b.tempo)==null?void 0:x.toFixed(1)," BPM"]})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Key:"}),s.jsx("span",{className:"value",children:($=c.reference_data)==null?void 0:$.key})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Phrases:"}),s.jsx("span",{className:"value",children:(J=(I=c.reference_data)==null?void 0:I.phrases)==null?void 0:J.length})]})]})]})]})}const Ye=({songData:l,apiBase:h,onTimeUpdate:g,onStartSession:f,onSessionComplete:N,isSessionActive:S,onSessionToggle:c})=>{var ge,Se,ye;const p=t.useRef(null),[O,P]=t.useState(!1),[q,d]=t.useState(0),[R,b]=t.useState(0),[x,$]=t.useState(.7),[I,J]=t.useState(!1),n=t.useRef(null),o=t.useRef(S),a=t.useRef(null),[k,Z]=t.useState(!1),[D,V]=t.useState(0),U=t.useRef(0);t.useEffect(()=>{if(U.current=D,o.current=S,k&&a.current&&p.current&&D!==0){const u=p.current.currentTime+D;u>=0&&u<a.current.duration&&(a.current.currentTime=u)}},[D,S,k]);const oe=l!=null&&l.karaoke_video?`${h}${l.karaoke_video.startsWith("/")?"":"/"}${l.karaoke_video}`:null,z=l!=null&&l.reference_vocals?`${h}${l.reference_vocals.startsWith("/")?"":"/"}${l.reference_vocals}`:null,re=t.useCallback((u,M)=>{if(!p.current)return;const Y=p.current,le=M?M.mediaTime:Y.currentTime,e=Math.max(0,le+U.current);if(d(le),g&&g(e),k&&a.current&&!a.current.paused&&Math.random()<.2){const r=a.current.currentTime;Math.abs(r-e)>.1&&(a.current.currentTime=e)}!Y.paused&&!Y.ended&&Y.requestVideoFrameCallback&&(n.current=Y.requestVideoFrameCallback(re))},[g,k]),K=t.useCallback(()=>{if(!p.current)return;const u=p.current,M=Math.max(0,u.currentTime+U.current);d(u.currentTime),g&&g(M)},[g]);t.useEffect(()=>{const u=p.current;if(!u)return;const M=()=>{b(u.duration),J(!0),console.log("Video ready:",u.duration,"seconds")},Y=()=>{if(P(!0),u.requestVideoFrameCallback&&(n.current=u.requestVideoFrameCallback(re)),k&&a.current){const r=u.currentTime+U.current;a.current.currentTime=Math.max(0,r),a.current.play().catch(()=>{})}},le=()=>{P(!1),n.current!==null&&u.cancelVideoFrameCallback&&(u.cancelVideoFrameCallback(n.current),n.current=null),a.current&&!a.current.paused&&a.current.pause()},e=()=>{P(!1),o.current&&c&&c(!1),a.current&&(a.current.pause(),a.current.currentTime=0)};return u.addEventListener("loadedmetadata",M),u.addEventListener("play",Y),u.addEventListener("pause",le),u.addEventListener("ended",e),u.addEventListener("timeupdate",K),()=>{u.removeEventListener("loadedmetadata",M),u.removeEventListener("play",Y),u.removeEventListener("pause",le),u.removeEventListener("ended",e),u.removeEventListener("timeupdate",K),n.current!==null&&u.cancelVideoFrameCallback&&u.cancelVideoFrameCallback(n.current)}},[re,K,S,c,k]),t.useEffect(()=>{p.current&&(p.current.volume=x)},[x]);const ne=t.useCallback(async()=>{const u=p.current;if(u)try{u.paused?(u.muted&&(console.warn("Video was muted, unmuting..."),u.muted=!1),await u.play(),console.log("Video play started successfully")):(u.pause(),console.log("Video paused"))}catch(M){console.error("Video play/pause error:",M),alert(`Video playback error: ${M.message}`)}},[]),me=t.useCallback(u=>{const M=p.current;if(!M)return;const Y=u.currentTarget.getBoundingClientRect(),e=(u.clientX-Y.left)/Y.width*R,r=Math.max(0,e+U.current);M.currentTime=e,d(e),g&&g(r),a.current&&(a.current.currentTime=r,k&&!M.paused&&a.current.play().catch(()=>{}))},[R,g,k]),be=async()=>{if(o.current)c&&c(!1),p.current&&!p.current.paused&&p.current.pause(),a.current&&!a.current.paused&&a.current.pause();else if(f&&await f(),c&&c(!0),p.current&&p.current.paused)try{p.current.muted&&(console.warn("Video was muted on session start, unmuting..."),p.current.muted=!1),await p.current.play(),console.log("Auto-play started for session")}catch(u){console.error("Auto-play failed:",u),alert(`Auto-play failed: ${u.message}. Please click play manually.`)}},ue=u=>{const M=Math.floor(u/60),Y=Math.floor(u%60);return`${M}:${Y.toString().padStart(2,"0")}`};return l?s.jsxs("div",{className:"video-karaoke-player",children:[s.jsxs("div",{className:"video-container",children:[s.jsx("video",{ref:p,className:"karaoke-video",src:oe,crossOrigin:"anonymous",playsInline:!0,preload:"auto",children:"Your browser does not support the video tag."}),s.jsx("div",{className:"video-overlay",children:s.jsx("button",{className:"play-pause-overlay",onClick:ne,"aria-label":O?"Pause":"Play",children:O?"â¸ï¸":"â–¶ï¸"})})]}),s.jsxs("div",{className:"playback-controls",children:[s.jsxs("div",{className:"progress-section",children:[s.jsx("span",{className:"time-display",children:ue(q)}),s.jsx("div",{className:"progress-bar",onClick:me,children:s.jsx("div",{className:"progress-fill",style:{width:`${q/R*100}%`}})}),s.jsx("span",{className:"time-display",children:ue(R)})]}),s.jsxs("div",{className:"control-buttons",children:[s.jsx("button",{className:"control-btn",onClick:ne,disabled:!I,children:O?"â¸ï¸ PAUSE":"â–¶ï¸ PLAY"}),s.jsx("button",{className:`control-btn ${S?"active":""}`,onClick:be,disabled:!I,children:S?"â¹ï¸ STOP SESSION":"ðŸŽ¤ START SESSION"}),s.jsxs("div",{className:"volume-control",children:[s.jsx("span",{className:"volume-icon",children:"ðŸ”Š"}),s.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:x,onChange:u=>$(parseFloat(u.target.value)),className:"volume-slider"})]}),s.jsxs("div",{className:"sync-control",children:[s.jsx("span",{className:"sync-icon",title:"Video/Vocals Sync Offset",children:"â±ï¸"}),s.jsxs("span",{className:"sync-label",children:[D>0?"+":"",D.toFixed(2),"s"]}),s.jsx("input",{type:"range",min:"-3",max:"3",step:"0.05",value:D,onChange:u=>V(parseFloat(u.target.value)),className:"sync-slider"})]}),z&&s.jsx("button",{className:`control-btn ${k?"active":""}`,onClick:()=>{var M,Y;const u=!k;Z(u),a.current&&(a.current.currentTime=Math.max(0,(((M=p.current)==null?void 0:M.currentTime)||0)+U.current),u&&!((Y=p.current)!=null&&Y.paused)?a.current.play().catch(()=>{}):a.current.pause())},disabled:!I,children:k?"ðŸ”‡ MUTE REF":"ðŸ”ˆ PLAY REF"})]}),s.jsxs("div",{className:"song-info",children:[s.jsx("h3",{children:l.name||l.song_name||l.title||"Untitled Song"}),s.jsxs("div",{className:"song-metadata",children:[((ge=l.reference_data)==null?void 0:ge.tempo)&&s.jsxs("span",{className:"metadata-item",children:["â™© ",Math.round(l.reference_data.tempo)," BPM"]}),((Se=l.reference_data)==null?void 0:Se.key)&&s.jsxs("span",{className:"metadata-item",children:["ðŸŽ¹ ",l.reference_data.key]}),((ye=l.reference_data)==null?void 0:ye.duration)&&s.jsxs("span",{className:"metadata-item",children:["â±ï¸ ",Math.floor(l.reference_data.duration/60),":",String(Math.floor(l.reference_data.duration%60)).padStart(2,"0")]})]})]})]}),z&&s.jsx("audio",{ref:a,src:z,crossOrigin:"anonymous"})]}):s.jsx("div",{className:"video-karaoke-player",children:s.jsx("div",{className:"no-song",children:s.jsx("p",{children:"No song selected"})})})},qe=({referenceData:l,externalTime:h,isSessionActive:g,onSessionComplete:f})=>{const N=t.useRef(null),S=t.useRef(null),c=t.useRef(null),p=t.useRef(null),O=t.useRef(g);t.useEffect(()=>{O.current=g},[g]);const[P,q]=t.useState({total:0,pitch:0,energy:0}),[d,R]=t.useState({frequency:0,confidence:0,centsError:0,combo:0,energyMatch:0}),b=t.useRef({pitchSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,currentCombo:0,frequencies:[],energies:[]}),x=t.useRef(null),$=t.useRef(!1),I=t.useRef({detectedOffset:0,confidence:0,samples:[]}),J=t.useRef({minEnergySeen:1/0,maxEnergySeen:0,initialized:!1}),n=t.useRef({centsErrorBuffer:[],maxBufferSize:10}),o=t.useRef(g),a={PITCH_WEIGHT:.3,ENERGY_WEIGHT:.7,PITCH_PERFECT_CENTS:50,PITCH_GOOD_CENTS:100,PITCH_ACCEPTABLE_CENTS:200,KEY_SHIFT_MIN_SAMPLES:10,KEY_SHIFT_TOLERANCE:100,KEY_SHIFT_MAX_OFFSET:200,ENERGY_MIN_THRESHOLD:.005,ENERGY_SMOOTHING_WINDOW:5,COMBO_THRESHOLD:.95,COMBO_BREAK_THRESHOLD:.6,EMA_ALPHA:.2,BACKBUFFER_MS:350,PITCH_FLOOR:.15,ENERGY_FLOOR:.1,MIN_CONFIDENCE:.2,LOW_CONFIDENCE_FLOOR:.3},k=t.useCallback(async()=>{try{console.log("Initializing audio processing with AEC..."),S.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3,latencyHint:"interactive"});const e=S.current;e.state==="suspended"&&(await e.resume(),console.log("Audio context resumed from suspended state"));try{await e.audioWorklet.addModule("/workers/pitch-processor-aec.js"),console.log("âœ… AudioWorklet loaded successfully")}catch(m){console.warn("Failed to load AudioWorklet, using fallback:",m),console.log("Continuing without AudioWorklet - basic audio processing only")}const r=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!1,sampleRate:48e3,channelCount:1}}).catch(async m=>(console.warn("Failed to get microphone with constraints, trying fallback:",m),await navigator.mediaDevices.getUserMedia({audio:!0})));p.current=r;const i=e.createMediaStreamSource(r);try{const m=new AudioWorkletNode(e,"pitch-processor-aec");c.current=m,m.port.onmessage=v=>{v.data.type==="audio-data"&&Z(v.data)},i.connect(m),console.log("âœ… AudioWorklet processing initialized")}catch(m){console.warn("AudioWorklet failed, using basic audio monitoring:",m);const v=e.createAnalyser();i.connect(v);const j=setInterval(()=>{O.current?Z({frequency:440,confidence:.8,energy:.5,centroid:1e3,aecReduction:.1,timestamp:Date.now()}):clearInterval(j)},100);console.log("âœ… Basic audio monitoring initialized")}}catch(e){console.error("Failed to initialize audio:",e),e.name==="NotAllowedError"?alert("Microphone access denied. Please allow microphone access and refresh the page."):e.name==="NotFoundError"?alert("No microphone found. Please connect a microphone and refresh the page."):e.name==="NotSupportedError"?alert("AudioWorklet not supported. Please use HTTPS or a modern browser (Chrome, Firefox, Safari)."):alert(`Audio initialization failed: ${e.message}. Please check your microphone and browser settings.`),R(r=>({...r,frequency:0,confidence:0,error:e.message}))}},[]),Z=t.useCallback(e=>{if(console.log("ðŸŽ¤ Audio data received:",e),!O.current||!l){console.log("Session not active or no reference data");return}const{frequency:r,confidence:i,energy:m,centroid:v,aecReduction:j}=e,E=h,y=D(E);if(!y)return;const A=r>0&&i>=a.MIN_CONFIDENCE&&y.f0>0,C=A?oe(r,i,y,E):null,H=A?z(m,y):null,w=C===null?0:a.PITCH_WEIGHT,X=H===null?0:a.ENERGY_WEIGHT,G=w+X,L=G>0?((C??0)*w+(H??0)*X)/G:null;L!==null&&K(L);const B=1e4;b.current.pitchSamples.push(C),b.current.energySamples.push(H),b.current.timestamps.push(E),b.current.frequencies.push(r),b.current.energies.push(m),b.current.pitchSamples.length>B&&(b.current.pitchSamples.shift(),b.current.energySamples.shift(),b.current.timestamps.shift(),b.current.frequencies.shift(),b.current.energies.shift());const T=re(r,y.f0);R(W=>({frequency:r,confidence:i,centsError:T,combo:W.combo,energyMatch:H})),q(W=>({total:L!==null?ne(W.total,L*100,a.EMA_ALPHA):W.total,pitch:C!==null?ne(W.pitch,C*100,a.EMA_ALPHA):W.pitch,energy:H!==null?ne(W.energy,H*100,a.EMA_ALPHA):W.energy}))},[l,h]),D=t.useCallback(e=>{if(!l||!l.f0_ref_on_k)return null;const r=l.fps||50,i=Math.floor(e*r);if(i<0||i>=l.f0_ref_on_k.length)return null;const m=l.f0_ref_on_k[i],v=l.beats_k||[],j=v.reduce((A,C)=>Math.abs(C-e)<Math.abs(A-e)?C:A,v[0]||0),E=l.loudness_ref||[],y=E[Math.floor(i*E.length/l.f0_ref_on_k.length)];return{f0:(m==null?void 0:m.f0)||0,conf:(m==null?void 0:m.conf)||0,nearestBeat:j,beatDistance:Math.abs(e-j),loudness:(y==null?void 0:y.LUFS)||-30}},[l]),V=(e,r,i)=>1/(1+Math.exp(-(e-r)/i)),U=e=>{const r=V(e,.3,.1);return a.PITCH_FLOOR+r*(1-a.PITCH_FLOOR)},oe=t.useCallback((e,r,i,m)=>{const v=V(e,20,10),j=V(i.f0,20,10),E=v*j,y=Math.max(e,.1),A=Math.max(i.f0,.1);let C=re(y,A);I.current.samples.push(C);const H=20;if(I.current.samples.length>H&&I.current.samples.shift(),I.current.samples.length>a.KEY_SHIFT_MIN_SAMPLES){const ie=me(I.current.samples),ae=Math.tanh((Math.abs(ie)-a.KEY_SHIFT_TOLERANCE)/50);ae>0&&(C-=ie*Math.max(0,ae))}n.current.centsErrorBuffer.push(C),n.current.centsErrorBuffer.length>n.current.maxBufferSize&&n.current.centsErrorBuffer.shift();const w=me(n.current.centsErrorBuffer),X=Math.abs(w),G=220,L=Math.exp(-X/G),B=a.PITCH_FLOOR+(1-a.PITCH_FLOOR)*L,T=U(r);return B*T*E+a.PITCH_FLOOR*(1-E)},[]),z=t.useCallback((e,r)=>{const i=J.current;i.initialized||(i.minEnergySeen=Math.max(e,1e-6),i.maxEnergySeen=Math.max(e,1e-6),i.initialized=!0);const m=.05;e>i.maxEnergySeen&&(i.maxEnergySeen=e),e>1e-6&&e<i.minEnergySeen&&(i.minEnergySeen=i.minEnergySeen*(1-m)+e*m);const v=1e-10,j=Math.log10(e+v),E=Math.log10(i.minEnergySeen+v),y=Math.log10(i.maxEnergySeen+v),A=Math.max(y-E,.01);let C=(j-E)/A;C=Math.tanh(C*2);const H=a.ENERGY_FLOOR+(1-a.ENERGY_FLOOR)*(C+1)/2,w=V(e,a.ENERGY_MIN_THRESHOLD,.002);return a.ENERGY_FLOOR*(1-w)+H*w},[]),re=(e,r)=>e===0||r===0?0:1200*Math.log2(e/r),K=e=>{if(e>=a.COMBO_THRESHOLD){if($.current)return;x.current&&(clearTimeout(x.current),x.current=null);const r=b.current.currentCombo+1;b.current.currentCombo=r,b.current.combos.push(r),b.current.maxCombo=Math.max(b.current.maxCombo,r),R(i=>({...i,combo:r}))}else b.current.currentCombo>0&&(b.current.currentCombo=0,$.current=!0,x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{R(r=>({...r,combo:0})),$.current=!1,x.current=null},1500)),b.current.combos.push(0)},ne=(e,r,i)=>i*r+(1-i)*e,me=e=>{if(e.length===0)return 0;const r=[...e].sort((m,v)=>m-v),i=Math.floor(r.length/2);return r.length%2===0?(r[i-1]+r[i])/2:r[i]};t.useEffect(()=>{const e=N.current;if(!e)return;const r=e.getContext("2d",{alpha:!1}),i=e.width,m=e.height;let v=null,j=0;const y=1e3/30,A=C=>{C-j>=y&&(r.fillStyle="#000",r.fillRect(0,0,i,m),be(r,i,m),ge(r,i,m),Se(r,i,m),ye(r),j=C),v=requestAnimationFrame(A)};return v=requestAnimationFrame(A),()=>{v!==null&&cancelAnimationFrame(v)}},[d,P,l,h]);const be=(e,r,i)=>{const m=i*.35,v=i*.38,j=30,E=r-60,y=r/2;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(j,m,E,v),e.strokeStyle="rgba(0, 255, 255, 0.2)",e.lineWidth=1;const A=[82.4,164.8,329.6,659.2];for(let _ of A){const F=ue(_,m,v);e.beginPath(),e.moveTo(j,F),e.lineTo(j+E,F),e.stroke()}if(e.strokeStyle="#0ff",e.lineWidth=2,e.strokeRect(j,m,E,v),!l||!l.f0_ref_on_k)return;const C=3,H=.5,w=h,X=w-H,G=w+C,L=l.f0_ref_on_k;let B=0,T=L.length;for(;B<T;){const _=B+T>>1;L[_].t<X?B=_+1:T=_}T=L.length;let W=B;for(;W<T;){const _=W+T>>1;L[_].t<=G?W=_+1:T=_}const ie=[];for(let _=B;_<T;_++){const F=L[_];F.f0>0&&F.conf>.3&&ie.push(F)}const ae=[];let te=null;const _e=1200;for(let _=0;_<ie.length;_++){const F=ie[_];if(!te)te={startTime:F.t,endTime:F.t,f0:F.f0,conf:F.conf};else{const ee=F.t-te.endTime,de=Math.abs(_e*Math.log2(F.f0/te.f0));ee<.1&&de<50?(te.endTime=F.t,te.f0=(te.f0+F.f0)*.5):(ae.push(te),te={startTime:F.t,endTime:F.t,f0:F.f0,conf:F.conf})}}te&&ae.push(te),ae.forEach(_=>{const F=ue(_.f0,m,v),ee=8,de=_.startTime-w,xe=E/(C+H),ve=y+de*xe,Oe=_.endTime-_.startTime,Ce=Math.max(4,Oe*xe),je=_.startTime<=w&&_.endTime>=w,Ae=Math.abs(_.startTime-w)<.2;if(ve+Ce>=j&&ve<=j+E){je?(e.fillStyle="#ff0",e.shadowBlur=15,e.shadowColor="#ff0"):Ae?(e.fillStyle="#f0f",e.shadowBlur=10,e.shadowColor="#f0f"):(e.fillStyle="rgba(0, 255, 255, 0.6)",e.shadowBlur=0);const Q=Math.max(j,ve),fe=Math.min(Ce,j+E-Q),se=F-ee/2,ce=2;e.beginPath(),e.moveTo(Q+ce,se),e.lineTo(Q+fe-ce,se),e.quadraticCurveTo(Q+fe,se,Q+fe,se+ce),e.lineTo(Q+fe,se+ee-ce),e.quadraticCurveTo(Q+fe,se+ee,Q+fe-ce,se+ee),e.lineTo(Q+ce,se+ee),e.quadraticCurveTo(Q,se+ee,Q,se+ee-ce),e.lineTo(Q,se+ce),e.quadraticCurveTo(Q,se,Q+ce,se),e.closePath(),e.fill(),e.shadowBlur=0,e.strokeStyle=je?"#fff":"rgba(0, 255, 255, 0.8)",e.lineWidth=je?2:1,e.stroke()}}),e.strokeStyle="#fff",e.lineWidth=2,e.setLineDash([5,5]),e.beginPath(),e.moveTo(y,m),e.lineTo(y,m+v),e.stroke(),e.setLineDash([]);const pe=m+v+12;if(e.font="9px monospace",e.textAlign="center",e.fillStyle="#0f0",e.beginPath(),e.arc(y-60,pe,5,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.textAlign="left",e.fillText("= YOU",y-53,pe+3),e.strokeStyle="#f0f",e.lineWidth=2,e.beginPath(),e.moveTo(y+20,pe),e.lineTo(y+35,pe),e.stroke(),e.fillStyle="#fff",e.fillText("= TARGET",y+38,pe+3),d.frequency>0&&d.confidence>.2){const _=ue(d.frequency,m,v),F=D(h);if(F&&F.f0>0){const de=ue(F.f0,m,v);e.strokeStyle=d.confidence>.5?"rgba(0, 255, 0, 0.5)":"rgba(255, 255, 0, 0.5)",e.lineWidth=2,e.beginPath(),e.moveTo(y,_),e.lineTo(y,de),e.stroke(),e.strokeStyle="#f0f",e.fillStyle="#f0f",e.shadowBlur=12,e.shadowColor="#f0f",e.lineWidth=3,e.beginPath(),e.moveTo(y-25,de),e.lineTo(y+25,de),e.stroke(),e.font="bold 11px monospace",e.textAlign="left",e.fillText("TARGET",y+30,de+4),e.shadowBlur=0}const ee=d.confidence>.5?"#0f0":"#ff0";e.fillStyle=ee,e.strokeStyle="#fff",e.shadowBlur=15,e.shadowColor=ee,e.beginPath(),e.arc(y,_,10,0,Math.PI*2),e.fill(),e.lineWidth=2,e.stroke(),e.font="bold 11px monospace",e.textAlign="right",e.fillStyle=ee,e.fillText("YOU",y-15,_+4),e.shadowBlur=0}},ue=(e,r,i)=>{const j=Math.max(80,Math.min(1e3,e)),E=Math.log2(j),y=Math.log2(80),A=Math.log2(1e3),C=(E-y)/(A-y);return r+i*(1-C)},ge=(e,r,i)=>{const m=i*.78,v=r-60,j=18,E=30;e.fillStyle="#333",e.fillRect(E,m,v,j),e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.moveTo(r/2,m),e.lineTo(r/2,m+j),e.stroke();const y=50,A=d.centsError/y*(v/2),C=r/2+A,H=Math.abs(d.centsError);let w="#0f0";H>25&&(w="#ff0"),H>50&&(w="#f00"),e.fillStyle=w,e.fillRect(C-3,m,6,j),e.fillStyle="#fff",e.font="11px monospace",e.textAlign="center",e.fillText(`${d.centsError.toFixed(0)} Â¢`,r/2,m+j+15)},Se=(e,r,i)=>{d.combo>=2&&(e.fillStyle="#ff0",e.font="bold 32px monospace",e.textAlign="center",e.fillText(`${d.combo}x`,r/2,i*.12),e.font="bold 20px monospace",e.fillText("COMBO!",r/2,i*.16))},ye=(e,r,i)=>{const j=y=>y>=90?"#0f0":y>=75?"#0ff":y>=60?"#ff0":"#f80",E=(y,A,C,H)=>{e.font="bold 12px monospace",e.fillStyle="#888",e.textAlign="left",e.fillText(y,15,C-8);const w=H||j(A);e.shadowBlur=15,e.shadowColor=w,e.font="bold 32px monospace",e.fillStyle=w,e.fillText(`${A.toFixed(0)}%`,15,C+20),e.shadowBlur=0;const X=120,G=6,L=15,B=C+26;e.fillStyle="#222",e.fillRect(L,B,X,G);const T=e.createLinearGradient(L,B,L+X,B);A>=90?(T.addColorStop(0,"#0f0"),T.addColorStop(1,"#0ff")):A>=75?(T.addColorStop(0,"#0ff"),T.addColorStop(1,"#08f")):A>=60?(T.addColorStop(0,"#ff0"),T.addColorStop(1,"#f80")):(T.addColorStop(0,"#f80"),T.addColorStop(1,"#f00")),e.fillStyle=T;const W=A/100*X;e.fillRect(L,B,W,G),e.strokeStyle=w,e.lineWidth=1,e.strokeRect(L,B,X,G)};e.font="bold 14px monospace",e.fillStyle="#fff",e.textAlign="left",e.fillText("TOTAL SCORE",15,30),e.shadowBlur=20,e.shadowColor=j(P.total),e.font="bold 42px monospace",e.fillStyle=j(P.total),e.fillText(`${P.total.toFixed(0)}%`,15,30+38),e.shadowBlur=0,e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.moveTo(15,30+50),e.lineTo(15+140,30+50),e.stroke(),E("PITCH",P.pitch,30+70,null),E("ENERGY",P.energy,30+125,null)},u=t.useCallback(e=>e.filter(r=>typeof r=="number"&&Number.isFinite(r)),[]),M=t.useCallback(e=>{const r=u(e);return r.length===0?0:r.reduce((i,m)=>i+m,0)/r.length},[u]),Y=t.useCallback(e=>{const r=u(e);if(r.length===0)return 0;const i=M(r),m=r.reduce((v,j)=>v+Math.pow(j-i,2),0)/r.length;return Math.sqrt(m)},[u,M]),le=t.useCallback(()=>{const e=b.current;if(e.timestamps.length===0)return console.warn("No performance data collected"),null;const r=M(e.pitchSamples)*100,i=M(e.energySamples)*100,m=r*a.PITCH_WEIGHT+i*a.ENERGY_WEIGHT,v=e.timestamps.map((G,L)=>{const B=e.pitchSamples[L];return typeof B!="number"?null:{time:G,score:B*100}}).filter(Boolean),j=e.timestamps.map((G,L)=>({time:G,energy:e.energies[L]})),E=[];e.maxCombo>=5&&E.push({name:"Combo King",description:`${e.maxCombo}x combo streak!`});const y=e.energySamples.length>0?1-Y(e.energySamples)/(M(e.energySamples)+.001):0,A=M(e.energySamples);y>=.5&&A>=.8&&E.push({name:"Mic Melter",description:"Sustained energy!"}),(e.pitchSamples.length>0?1-Y(e.pitchSamples)/(M(e.pitchSamples)+.001):0)>=.65&&r>=65&&E.push({name:"Smooth Operator",description:"Consistent pitch!"});const H=[],w=10,X=Math.max(...e.timestamps);for(let G=0;G<X;G+=w){const L=Math.min(G+w,X),B=e.timestamps.map((T,W)=>T>=G&&T<L?W:-1).filter(T=>T>=0);if(B.length>0){const T=M(B.map(ae=>e.pitchSamples[ae]))*100,W=M(B.map(ae=>e.energySamples[ae]))*100,ie=T*a.PITCH_WEIGHT+W*a.ENERGY_WEIGHT;H.push({phrase:Math.floor(G/w),start:G,end:L,pitchScore:T,energyScore:W,totalScore:ie})}}return{totals:{total:m,pitch:r,energy:i,motion:0},badges:E,graphs:{pitchTimeline:v,energyGraph:j},perPhrase:H,performance_data:e}},[]);return t.useEffect(()=>{if(o.current&&!g&&b.current.timestamps.length>0){console.log("ðŸŽ¤ Session ended, computing final results...");const e=le();e&&f&&(console.log("ðŸŽ¤ Final results:",e),f(e))}o.current=g},[g,le,f]),t.useEffect(()=>(O.current?(console.log("ðŸŽ¤ Session active, initializing audio processing..."),o.current||(console.log("ðŸŽ¤ Resetting performance data for new session"),b.current={pitchSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,currentCombo:0,frequencies:[],energies:[]},x.current&&(clearTimeout(x.current),x.current=null),$.current=!1,R(e=>({...e,combo:0})),I.current={detectedOffset:0,confidence:0,samples:[]},J.current={minEnergySeen:1/0,maxEnergySeen:0,initialized:!1},n.current={centsErrorBuffer:[],maxBufferSize:10}),S.current?(console.log("ðŸŽ¤ Audio context already exists, ensuring processing is active"),c.current?console.log("ðŸŽ¤ AudioWorklet is active"):(console.log("ðŸŽ¤ AudioWorklet not active, reinitializing..."),k())):k()):(console.log("ðŸŽ¤ Session inactive, stopping audio processing"),p.current&&(p.current.getTracks().forEach(e=>e.stop()),p.current=null),S.current&&S.current.state!=="closed"&&(S.current.close().catch(()=>{}),S.current=null),c.current=null,x.current&&(clearTimeout(x.current),x.current=null),$.current=!1),()=>{p.current&&p.current.getTracks().forEach(e=>e.stop()),S.current&&S.current.state!=="closed"&&S.current.close().catch(()=>{}),x.current&&(clearTimeout(x.current),x.current=null),$.current=!1}),[g,k]),s.jsxs("div",{className:"live-hud",children:[s.jsx("canvas",{ref:N,width:500,height:700,className:"hud-canvas"}),I.current.confidence>.5&&s.jsxs("div",{className:"key-shift-indicator",children:["Key shifted: ",I.current.detectedOffset>0?"+":"",I.current.detectedOffset.toFixed(0)," cents"]})]})};function $e({onComplete:l}){const[h,g]=t.useState(null),[f,N]=t.useState(0),[S,c]=t.useState(!1),p=t.useRef(null),O=t.useRef(null),P=t.useRef(null),q=t.useRef(null);t.useEffect(()=>()=>{q.current&&cancelAnimationFrame(q.current),P.current&&P.current.getTracks().forEach(o=>o.stop())},[]);const d=async()=>{try{const o=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});P.current=o,g(!0),R(o)}catch(o){console.error("Microphone access denied:",o),g(!1)}},R=o=>{try{p.current=new(window.AudioContext||window.webkitAudioContext),p.current.state==="suspended"&&p.current.resume().catch(()=>{}),O.current=p.current.createAnalyser(),O.current.fftSize=256,O.current.smoothingTimeConstant=.8,p.current.createMediaStreamSource(o).connect(O.current),b()}catch(a){console.error("Audio analysis setup failed:",a)}},b=()=>{const o=new Uint8Array(O.current.frequencyBinCount),a=new Uint8Array(O.current.fftSize),k=()=>{if(O.current){O.current.getByteFrequencyData(o),O.current.getByteTimeDomainData(a);let Z=0;for(let K=0;K<o.length;K++)Z+=o[K]*o[K];const D=Math.sqrt(Z/o.length);let V=0;for(let K=0;K<a.length;K++){const ne=a[K]-128;V+=ne*ne}const U=Math.sqrt(V/a.length),oe=Math.max(D*.5,U),z=Math.min(oe/32,1),re=Math.max(z,.02);N(re),q.current=requestAnimationFrame(k)}};k()},x=()=>c(!0),$=()=>c(!1),I=()=>l(),J=()=>f<.1?"#ff3d00":f<.3?"#ffd700":f<.7?"#39ff14":"#ff00e6",n=()=>f<.1?"TOO QUIET":f<.3?"GETTING THERE":f<.7?"PERFECT":"TOO LOUD";return s.jsxs("div",{className:"mic-check-container",children:[s.jsxs("div",{className:"mic-check-header",children:[s.jsx("h2",{className:"neon-text",children:"ðŸŽ¤ MIC CHECK ðŸŽ¤"}),s.jsx("p",{children:"Let's make sure everything is working perfectly!"})]}),s.jsxs("div",{className:"mic-check-content",children:[s.jsxs("div",{className:"mic-section",children:[s.jsx("h3",{children:"Microphone"}),h===null&&s.jsx("button",{className:"retro-button large",onClick:d,children:"ðŸŽ¤ ENABLE MICROPHONE"}),h===!1&&s.jsxs("div",{className:"permission-denied",children:[s.jsx("p",{children:"âŒ Microphone access denied"}),s.jsx("p",{children:"Please allow microphone access to continue"}),s.jsx("button",{className:"retro-button",onClick:d,children:"TRY AGAIN"})]}),h===!0&&s.jsxs("div",{className:"mic-status",children:[s.jsx("div",{className:"audio-level-display",children:s.jsx("div",{className:"audio-level-bar",style:{height:`${f*100}%`,backgroundColor:J()}})}),s.jsxs("div",{className:"audio-level-info",children:[s.jsx("p",{className:`level-text ${n().replace(" ","-").toLowerCase()}`,children:n()}),s.jsxs("p",{className:"level-value",children:[(f*100).toFixed(0),"%"]})]}),s.jsx("div",{className:"mic-controls",children:S?s.jsx("button",{className:"retro-button",onClick:$,children:"â¹ï¸ STOP LISTENING"}):s.jsx("button",{className:"retro-button",onClick:x,children:"ðŸŽµ START LISTENING"})})]})]}),s.jsxs("div",{className:"instructions",children:[s.jsx("h4",{children:"Instructions:"}),s.jsxs("ul",{children:[s.jsx("li",{children:"ðŸŽ¤ Enable microphone and test your audio levels"}),s.jsx("li",{children:"ðŸŽµ Sing a few notes to test your setup"}),s.jsx("li",{children:"âœ¨ When ready, proceed to the live performance!"})]})]}),h===!0&&s.jsxs("div",{className:"proceed-section",children:[s.jsx("button",{className:"retro-button large proceed",onClick:I,disabled:f<.02,children:"ðŸš€ START PERFORMANCE"}),f<.02&&s.jsx("p",{className:"warning",children:"âš ï¸ Please test your microphone first"})]})]})]})}function De({apiBase:l,onBack:h,onNewSession:g}){const[f,N]=t.useState([]),[S,c]=t.useState(!0);t.useEffect(()=>{p()},[]);const p=t.useCallback(async()=>{try{const R=await(await fetch(`${l}/leaderboard?limit=20`)).json();N(R)}catch(d){console.error("Failed to load leaderboard:",d)}finally{c(!1)}},[l]),O=t.useCallback(d=>d===1?"ðŸ¥‡":d===2?"ðŸ¥ˆ":d===3?"ðŸ¥‰":`#${d}`,[]),P=t.useCallback(d=>d>=90?"#39ff14":d>=80?"#ffd700":d>=70?"#ff9500":"#ff3d00",[]),q=t.useCallback(d=>{const R=new Date(d);return R.toLocaleDateString()+" "+R.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},[]);return S?s.jsx("div",{className:"leaderboard-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"LOADING LEADERBOARD..."})]})}):s.jsxs("div",{className:"leaderboard-container",children:[s.jsxs("div",{className:"leaderboard-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸ† LEADERBOARD ðŸ†"}),s.jsx("p",{className:"leaderboard-subtitle",children:"Top performers in the arcade!"})]}),s.jsx("div",{className:"leaderboard-content",children:f.length===0?s.jsxs("div",{className:"empty-leaderboard",children:[s.jsx("h2",{children:"ðŸŽ¤ NO SCORES YET"}),s.jsx("p",{children:"Be the first to submit a score!"}),s.jsx("button",{className:"retro-button large",onClick:g,children:"START SINGING"})]}):s.jsx("div",{className:"leaderboard-list",children:f.map((d,R)=>s.jsxs("div",{className:`leaderboard-entry ${R<3?"top-three":""}`,children:[s.jsx("div",{className:"rank",children:s.jsx("span",{className:"rank-icon",children:O(R+1)})}),s.jsxs("div",{className:"player-info",children:[s.jsx("h3",{className:"player-name",children:d.player_name}),s.jsx("p",{className:"play-date",children:q(d.played_at)})]}),s.jsxs("div",{className:"score-info",children:[s.jsx("div",{className:"total-score",style:{color:P(d.total_score)},children:Math.round(d.total_score)}),s.jsxs("div",{className:"score-breakdown",children:[s.jsxs("span",{children:["P: ",Math.round(d.pitch_score)]}),s.jsxs("span",{children:["E: ",Math.round(d.energy_score)]})]})]}),s.jsx("div",{className:"badges",children:d.badges&&d.badges.length>0&&s.jsx("div",{className:"badge-list",children:d.badges.map((b,x)=>s.jsxs("span",{className:"badge-mini",children:[b.name==="Combo King"&&"ðŸ‘‘",b.name==="Mic Melter"&&"ðŸ”¥",b.name==="Smooth Operator"&&"ðŸŽµ"]},x))})})]},d.id))})}),s.jsxs("div",{className:"leaderboard-actions",children:[s.jsx("button",{className:"retro-button",onClick:h,children:"â† BACK TO RESULTS"}),s.jsx("button",{className:"retro-button",onClick:g,children:"ðŸŽµ NEW SONG"}),s.jsx("button",{className:"retro-button",onClick:p,children:"ðŸ”„ REFRESH"})]}),s.jsxs("div",{className:"leaderboard-stats",children:[s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"TOTAL PLAYERS"}),s.jsx("span",{className:"stat-value",children:f.length})]}),s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"HIGHEST SCORE"}),s.jsx("span",{className:"stat-value",children:f.length>0?Math.round(f[0].total_score):0})]}),s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"AVERAGE SCORE"}),s.jsx("span",{className:"stat-value",children:t.useMemo(()=>{if(f.length===0)return 0;const d=f.reduce((R,b)=>R+b.total_score,0);return Math.round(d/f.length)},[f])})]})]})]})}function Ve({sessionId:l,results:h,apiBase:g,onNewSession:f,playerName:N,onPlayerNameChange:S}){const[c,p]=t.useState(h||null),[O,P]=t.useState(!h&&!!l),[q,d]=t.useState(!1),[R,b]=t.useState(!1);t.useEffect(()=>{h?(p(h),P(!1)):l&&x()},[l,h]);const x=t.useCallback(async()=>{try{const o=await(await fetch(`${g}/sessions/${l}/results`)).json();p(o.results||o)}catch(n){console.error("Failed to load results:",n)}finally{P(!1)}},[g,l]),$=t.useCallback(async()=>{if(!N.trim()){alert("Please enter your name!");return}try{(await fetch(`${g}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:l,player_name:N,scores:c.totals,badges:c.badges})})).ok&&(b(!0),d(!0))}catch(n){console.error("Failed to submit to leaderboard:",n),alert("Failed to submit to leaderboard")}},[g,l,N,c]),I=t.useCallback(n=>n>=90?"#39ff14":n>=70?"#ffd700":n>=50?"#ff9500":"#ff3d00",[]),J=t.useCallback(n=>n>=95?"S+":n>=90?"S":n>=85?"A+":n>=80?"A":n>=75?"B+":n>=70?"B":n>=65?"C+":n>=60?"C":n>=50?"D":"F",[]);return O?s.jsx("div",{className:"results-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"CALCULATING RESULTS..."})]})}):c?s.jsx("div",{className:"results-container",children:q?s.jsx(De,{apiBase:g,onBack:()=>d(!1),onNewSession:f}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"results-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ PERFORMANCE COMPLETE! ðŸŽ¤"}),s.jsxs("div",{className:"final-score",children:[s.jsx("span",{className:"score-label",children:"FINAL SCORE"}),s.jsx("span",{className:"score-value",style:{color:I(c.totals.total)},children:Math.round(c.totals.total)}),s.jsx("span",{className:"score-grade",style:{color:I(c.totals.total)},children:J(c.totals.total)})]})]}),s.jsxs("div",{className:"score-breakdown",children:[s.jsx("h2",{children:"SCORE BREAKDOWN"}),s.jsxs("div",{className:"score-grid",children:[s.jsxs("div",{className:"score-item",children:[s.jsx("span",{className:"score-label",children:"PITCH"}),s.jsx("div",{className:"score-bar",children:s.jsx("div",{className:"score-fill pitch",style:{width:`${c.totals.pitch}%`}})}),s.jsx("span",{className:"score-value",children:Math.round(c.totals.pitch)})]}),s.jsxs("div",{className:"score-item",children:[s.jsx("span",{className:"score-label",children:"ENERGY"}),s.jsx("div",{className:"score-bar",children:s.jsx("div",{className:"score-fill energy",style:{width:`${c.totals.energy}%`}})}),s.jsx("span",{className:"score-value",children:Math.round(c.totals.energy)})]})]})]}),c.badges&&c.badges.length>0&&s.jsxs("div",{className:"badges-section",children:[s.jsx("h2",{children:"ðŸ† BADGES EARNED ðŸ†"}),s.jsx("div",{className:"badges-grid",children:c.badges.map((n,o)=>s.jsxs("div",{className:"badge",children:[s.jsxs("div",{className:"badge-icon",children:[n.name==="Combo King"&&"ðŸ‘‘",n.name==="Mic Melter"&&"ðŸ”¥",n.name==="Smooth Operator"&&"ðŸŽµ"]}),s.jsxs("div",{className:"badge-info",children:[s.jsx("h3",{children:n.name}),s.jsx("p",{children:n.description})]})]},o))})]}),c.graphs&&s.jsxs("div",{className:"charts-section",children:[s.jsx("h2",{children:"ðŸ“Š PERFORMANCE ANALYSIS"}),s.jsxs("div",{className:"chart-container",children:[s.jsx("h3",{children:"Pitch Timeline"}),s.jsx("div",{className:"chart",children:s.jsx("svg",{width:"100%",height:"200",viewBox:"0 0 1000 100",preserveAspectRatio:"none",className:"pitch-chart",children:t.useMemo(()=>{const n=c.graphs.pitchTimeline||[];if(n.length===0)return null;const o=n.map(V=>V.time||0),a=Math.max(...o)||1,k=Math.min(...o)||0,Z=a-k,D=Z<2;return n.map((V,U)=>{const oe=D?U/(n.length-1||1)*1e3:(V.time-k)/Z*1e3,z=90-(V.score||0)/100*80;return s.jsx("circle",{cx:oe,cy:z,r:"3",fill:"#39ff14",opacity:"0.7"},U)})},[c])})})]}),s.jsxs("div",{className:"chart-container",children:[s.jsx("h3",{children:"Energy Graph"}),s.jsx("div",{className:"chart",children:s.jsx("svg",{width:"100%",height:"200",viewBox:"0 0 1000 100",preserveAspectRatio:"none",className:"energy-chart",children:t.useMemo(()=>{const n=c.graphs.energyGraph||[];if(n.length===0)return null;const o=n.map(z=>z.time||0),a=n.map(z=>z.energy||0),k=Math.max(...o)||1,Z=Math.min(...o)||0,D=k-Z,V=Math.max(...a)||1,U=D<2,oe=n.map((z,re)=>{const K=U?re/(n.length-1||1)*1e3:(z.time-Z)/D*1e3,me=90-(z.energy||0)/V*80;return`${K},${me}`}).join(" ");return s.jsx("polyline",{points:oe,fill:"none",stroke:"#ff00e6",strokeWidth:"2"})},[c])})})]})]}),c.perPhrase&&c.perPhrase.length>0&&s.jsxs("div",{className:"phrases-section",children:[s.jsx("h2",{children:"ðŸŽµ PHRASE BREAKDOWN"}),s.jsx("div",{className:"phrases-grid",children:c.perPhrase.map((n,o)=>s.jsxs("div",{className:"phrase-item",children:[s.jsxs("div",{className:"phrase-header",children:[s.jsxs("span",{className:"phrase-number",children:["Phrase ",n.phrase+1]}),s.jsxs("span",{className:"phrase-time",children:[n.start.toFixed(1),"s - ",n.end.toFixed(1),"s"]})]}),s.jsxs("div",{className:"phrase-scores",children:[s.jsxs("span",{children:["Pitch: ",Math.round(n.pitchScore)]}),s.jsxs("span",{children:["Energy: ",Math.round(n.energyScore)]})]}),s.jsxs("div",{className:"phrase-total",children:["Total: ",Math.round(n.totalScore)]})]},o))})]}),!R&&s.jsxs("div",{className:"leaderboard-submission",children:[s.jsx("h2",{children:"ðŸ† SUBMIT TO LEADERBOARD"}),s.jsxs("div",{className:"submission-form",children:[s.jsx("input",{type:"text",placeholder:"Enter your name",value:N,onChange:n=>S(n.target.value),className:"name-input",maxLength:20}),s.jsx("button",{className:"retro-button large",onClick:$,disabled:!N.trim(),children:"SUBMIT SCORE"})]})]}),s.jsxs("div",{className:"results-actions",children:[s.jsx("button",{className:"retro-button",onClick:f,children:"ðŸŽµ NEW SONG"}),s.jsx("button",{className:"retro-button",onClick:()=>d(!0),children:"ðŸ“Š LEADERBOARD"})]})]})}):s.jsx("div",{className:"results-container",children:s.jsxs("div",{className:"error",children:[s.jsx("h2",{children:"âŒ RESULTS NOT FOUND"}),s.jsx("button",{className:"retro-button",onClick:f,children:"START NEW SESSION"})]})})}const he="http://localhost:8080";function ze(){const[l,h]=t.useState("library"),[g,f]=t.useState(null),[N,S]=t.useState(null),[c,p]=t.useState(""),[O,P]=t.useState(0),[q,d]=t.useState(!1),[R,b]=t.useState(null),x=o=>{f(o),h("mic-check")},$=()=>{h("karaoke")},I=async o=>{try{N?(await fetch(`${he}/sessions/${N}/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).catch(a=>console.warn("Failed to save results to backend:",a)),c&&await fetch(`${he}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:N,player_name:c,scores:o.totals,badges:o.badges})}).catch(a=>console.warn("Failed to submit to leaderboard:",a))):console.warn("No session ID, results not saved to backend"),b(o),h("results")}catch(a){console.error("Error in handleSessionComplete:",a),b(o),h("results")}},J=()=>{h("library"),f(null),S(null),p(""),d(!1),b(null)},n=()=>{switch(l){case"library":return s.jsx(We,{onSongSelect:x,apiBase:he});case"mic-check":return s.jsx($e,{onComplete:$});case"karaoke":return s.jsxs("div",{className:"karaoke-stage",children:[s.jsx(Ye,{songData:g,apiBase:he,onSessionComplete:I,onStartSession:async()=>{try{const o=await fetch(`${he}/sessions/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({song_id:g.id})});if(!o.ok){const k=await o.json();throw console.error("Failed to start session:",k),new Error(k.error||"Failed to start session")}const a=await o.json();S(a.session_id)}catch(o){console.error("Error starting session:",o),alert(`Failed to start session: ${o.message}`),d(!1)}},onTimeUpdate:o=>P(o),isSessionActive:q,onSessionToggle:o=>d(o)}),s.jsx(qe,{referenceData:g==null?void 0:g.reference_data,externalTime:O,isSessionActive:q,onSessionComplete:I})]});case"results":return s.jsx(Ve,{sessionId:N,results:R,apiBase:he,onNewSession:J,playerName:c,onPlayerNameChange:p});default:return s.jsx("div",{children:"Unknown screen"})}};return s.jsxs("div",{className:"app",children:[s.jsx("header",{className:"app-header",children:s.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ PitchPerfectly ðŸŽ¤"})}),s.jsx("main",{className:"app-main",children:n()}),s.jsx("footer",{className:"app-footer",children:s.jsxs("div",{className:"controls",children:[s.jsx("button",{className:"retro-button",onClick:J,disabled:l==="library",children:"ðŸŽµ SONG LIBRARY"}),s.jsx("button",{className:"retro-button",onClick:()=>h("results"),disabled:!N,children:"ðŸ“Š LEADERBOARD"})]})})]})}const Re=document.querySelector(".loading-screen");Re&&(Re.style.display="none");Ee.createRoot(document.getElementById("root")).render(s.jsx(Le.StrictMode,{children:s.jsx(ze,{})}));
