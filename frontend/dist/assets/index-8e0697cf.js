import{r as n,a as we,R as Le}from"./vendor-b1791c80.js";(function(){const m=document.createElement("link").relList;if(m&&m.supports&&m.supports("modulepreload"))return;for(const N of document.querySelectorAll('link[rel="modulepreload"]'))u(N);new MutationObserver(N=>{for(const S of N)if(S.type==="childList")for(const a of S.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&u(a)}).observe(document,{childList:!0,subtree:!0});function g(N){const S={};return N.integrity&&(S.integrity=N.integrity),N.referrerPolicy&&(S.referrerPolicy=N.referrerPolicy),N.crossOrigin==="use-credentials"?S.credentials="include":N.crossOrigin==="anonymous"?S.credentials="omit":S.credentials="same-origin",S}function u(N){if(N.ep)return;N.ep=!0;const S=g(N);fetch(N.href,S)}})();var ke={exports:{}},be={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Fe=n,Pe=Symbol.for("react.element"),Ie=Symbol.for("react.fragment"),Be=Object.prototype.hasOwnProperty,He=Fe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ge={key:!0,ref:!0,__self:!0,__source:!0};function Me(l,m,g){var u,N={},S=null,a=null;g!==void 0&&(S=""+g),m.key!==void 0&&(S=""+m.key),m.ref!==void 0&&(a=m.ref);for(u in m)Be.call(m,u)&&!Ge.hasOwnProperty(u)&&(N[u]=m[u]);if(l&&l.defaultProps)for(u in m=l.defaultProps,m)N[u]===void 0&&(N[u]=m[u]);return{$$typeof:Pe,type:l,key:S,ref:a,props:N,_owner:He.current}}be.Fragment=Ie;be.jsx=Me;be.jsxs=Me;ke.exports=be;var s=ke.exports,Ee={},Te=we;Ee.createRoot=Te.createRoot,Ee.hydrateRoot=Te.hydrateRoot;function We({onSongSelect:l,apiBase:m}){var T,h,p,b,$,w,X;const[g,u]=n.useState([]),[N,S]=n.useState(!0),[a,f]=n.useState(null);n.useEffect(()=>{O()},[]);const O=async()=>{try{const i=await(await fetch(`${m}/library`)).json();u(i)}catch(j){console.error("Failed to load library:",j)}finally{S(!1)}},I=async j=>{try{const i=await fetch(`${m}/library/${j.id}`);if(!i.ok){const E=await i.json().catch(()=>({}));console.error("Failed to load song details:",E.error||i.statusText),alert(`Failed to load song: ${E.error||i.statusText}`);return}const t=await i.json();f(t),l(t)}catch(i){console.error("Failed to load song details:",i),alert(`Failed to load song: ${i.message}`)}},D=j=>new Date(j).toLocaleDateString();return N?s.jsx("div",{className:"library-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"LOADING LIBRARY..."})]})}):s.jsxs("div",{className:"library-container",children:[s.jsxs("div",{className:"library-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸŽµ SONG LIBRARY ðŸŽµ"}),s.jsx("div",{className:"library-controls",children:s.jsx("button",{className:"retro-button",onClick:O,children:"ðŸ”„ REFRESH"})})]}),s.jsx("div",{className:"library-content",children:g.length===0?s.jsxs("div",{className:"empty-library",children:[s.jsx("h2",{children:"ðŸŽ¤ NO SONGS IN LIBRARY"}),s.jsx("p",{children:"Place preprocessed references and videos to get started."})]}):s.jsx("div",{className:"songs-grid",children:g.map(j=>s.jsxs("div",{className:`song-card ${(a==null?void 0:a.id)===j.id?"selected":""}`,onClick:()=>I(j),children:[s.jsxs("div",{className:"song-info",children:[s.jsx("h3",{className:"song-title",children:j.name}),s.jsxs("p",{className:"song-date",children:["Added: ",D(j.uploaded_at)]}),s.jsx("div",{className:"song-status",children:s.jsx("span",{className:"status-badge ready",children:"âœ… READY"})})]}),s.jsx("div",{className:"song-actions",children:s.jsx("button",{className:"retro-button small",onClick:i=>{i.stopPropagation(),I(j)},children:"ðŸŽ¤ SING"})})]},j.id))})}),a&&s.jsxs("div",{className:"song-details",children:[s.jsxs("h3",{children:["Selected: ",a.name]}),s.jsxs("div",{className:"song-metadata",children:[s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Duration:"}),s.jsxs("span",{className:"value",children:[(h=(T=a.reference_data)==null?void 0:T.duration)==null?void 0:h.toFixed(1),"s"]})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Tempo:"}),s.jsxs("span",{className:"value",children:[(b=(p=a.reference_data)==null?void 0:p.tempo)==null?void 0:b.toFixed(1)," BPM"]})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Key:"}),s.jsx("span",{className:"value",children:($=a.reference_data)==null?void 0:$.key})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Phrases:"}),s.jsx("span",{className:"value",children:(X=(w=a.reference_data)==null?void 0:w.phrases)==null?void 0:X.length})]})]})]})]})}const Ye=({songData:l,apiBase:m,onTimeUpdate:g,onStartSession:u,onSessionComplete:N,isSessionActive:S,onSessionToggle:a})=>{var Se,ye,Ne;const f=n.useRef(null),[O,I]=n.useState(!1),[D,T]=n.useState(0),[h,p]=n.useState(0),[b,$]=n.useState(.7),[w,X]=n.useState(!1),j=n.useRef(null),i=n.useRef(S),t=n.useRef(null),[E,re]=n.useState(!1),[V,z]=n.useState(0),K=n.useRef(0);n.useEffect(()=>{if(K.current=V,i.current=S,E&&t.current&&f.current&&V!==0){const o=f.current.currentTime+V;o>=0&&o<t.current.duration&&(t.current.currentTime=o)}},[V,S,E]);const ae=l!=null&&l.karaoke_video?`${m}${l.karaoke_video.startsWith("/")?"":"/"}${l.karaoke_video}`:null,J=l!=null&&l.reference_vocals?`${m}${l.reference_vocals.startsWith("/")?"":"/"}${l.reference_vocals}`:null,Q=n.useCallback((o,M)=>{if(!f.current)return;const q=f.current,ce=M?M.mediaTime:q.currentTime,e=Math.max(0,ce+K.current);if(T(ce),g&&g(e),E&&t.current&&!t.current.paused&&Math.random()<.2){const r=t.current.currentTime;Math.abs(r-e)>.1&&(t.current.currentTime=e)}!q.paused&&!q.ended&&q.requestVideoFrameCallback&&(j.current=q.requestVideoFrameCallback(Q))},[g,E]),B=n.useCallback(()=>{if(!f.current)return;const o=f.current,M=Math.max(0,o.currentTime+K.current);T(o.currentTime),g&&g(M)},[g]);n.useEffect(()=>{const o=f.current;if(!o)return;const M=()=>{if(p(o.duration),X(!0),console.log("Video ready:",o.duration,"seconds"),o.audioTracks&&o.audioTracks.length>0){console.log(`Found ${o.audioTracks.length} audio tracks`);for(let r=0;r<o.audioTracks.length;r++)o.audioTracks[r].enabled=r===0;console.log("Audio track 0 enabled")}o.muted&&(console.warn("Video was muted on load, unmuting..."),o.muted=!1),o.volume=b,console.log("Video volume set to:",b)},q=()=>{if(I(!0),o.requestVideoFrameCallback&&(j.current=o.requestVideoFrameCallback(Q)),E&&t.current){const r=o.currentTime+K.current;t.current.currentTime=Math.max(0,r),t.current.play().catch(()=>{})}},ce=()=>{I(!1),j.current!==null&&o.cancelVideoFrameCallback&&(o.cancelVideoFrameCallback(j.current),j.current=null),t.current&&!t.current.paused&&t.current.pause()},e=()=>{I(!1),i.current&&a&&a(!1),t.current&&(t.current.pause(),t.current.currentTime=0)};return o.addEventListener("loadedmetadata",M),o.addEventListener("play",q),o.addEventListener("pause",ce),o.addEventListener("ended",e),o.addEventListener("timeupdate",B),()=>{o.removeEventListener("loadedmetadata",M),o.removeEventListener("play",q),o.removeEventListener("pause",ce),o.removeEventListener("ended",e),o.removeEventListener("timeupdate",B),j.current!==null&&o.cancelVideoFrameCallback&&o.cancelVideoFrameCallback(j.current)}},[Q,B,S,a,E]),n.useEffect(()=>{f.current&&w&&(f.current.volume=b,console.log("Volume updated to:",b))},[b,w]);const ee=n.useCallback(async()=>{const o=f.current;if(o)try{o.paused?(o.muted&&(console.warn("Video was muted, unmuting..."),o.muted=!1),await o.play(),console.log("Video play started successfully")):(o.pause(),console.log("Video paused"))}catch(M){console.error("Video play/pause error:",M),alert(`Video playback error: ${M.message}`)}},[]),me=n.useCallback(o=>{const M=f.current;if(!M)return;const q=o.currentTarget.getBoundingClientRect(),e=(o.clientX-q.left)/q.width*h,r=Math.max(0,e+K.current);M.currentTime=e,T(e),g&&g(r),t.current&&(t.current.currentTime=r,E&&!M.paused&&t.current.play().catch(()=>{}))},[h,g,E]),ge=async()=>{if(i.current)a&&a(!1),f.current&&!f.current.paused&&f.current.pause(),t.current&&!t.current.paused&&t.current.pause();else if(u&&await u(),a&&a(!0),f.current&&f.current.paused)try{f.current.muted&&(console.warn("Video was muted on session start, unmuting..."),f.current.muted=!1),await f.current.play(),console.log("Auto-play started for session")}catch(o){console.error("Auto-play failed:",o),alert(`Auto-play failed: ${o.message}. Please click play manually.`)}},le=o=>{const M=Math.floor(o/60),q=Math.floor(o%60);return`${M}:${q.toString().padStart(2,"0")}`};return l?s.jsxs("div",{className:"video-karaoke-player",children:[s.jsxs("div",{className:"video-container",children:[s.jsx("video",{ref:f,className:"karaoke-video",src:ae,crossOrigin:"anonymous",playsInline:!0,preload:"auto",children:"Your browser does not support the video tag."}),s.jsx("div",{className:"video-overlay",children:s.jsx("button",{className:"play-pause-overlay",onClick:ee,"aria-label":O?"Pause":"Play",children:O?"â¸ï¸":"â–¶ï¸"})})]}),s.jsxs("div",{className:"playback-controls",children:[s.jsxs("div",{className:"progress-section",children:[s.jsx("span",{className:"time-display",children:le(D)}),s.jsx("div",{className:"progress-bar",onClick:me,children:s.jsx("div",{className:"progress-fill",style:{width:`${D/h*100}%`}})}),s.jsx("span",{className:"time-display",children:le(h)})]}),s.jsxs("div",{className:"control-buttons",children:[s.jsx("button",{className:"control-btn",onClick:ee,disabled:!w,children:O?"â¸ï¸ PAUSE":"â–¶ï¸ PLAY"}),s.jsx("button",{className:`control-btn ${S?"active":""}`,onClick:ge,disabled:!w,children:S?"â¹ï¸ STOP SESSION":"ðŸŽ¤ START SESSION"}),s.jsxs("div",{className:"volume-control",children:[s.jsx("span",{className:"volume-icon",children:"ðŸ”Š"}),s.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:b,onChange:o=>$(parseFloat(o.target.value)),className:"volume-slider"})]}),s.jsxs("div",{className:"sync-control",children:[s.jsx("span",{className:"sync-icon",title:"Video/Vocals Sync Offset",children:"â±ï¸"}),s.jsxs("span",{className:"sync-label",children:[V>0?"+":"",V.toFixed(2),"s"]}),s.jsx("input",{type:"range",min:"-3",max:"3",step:"0.05",value:V,onChange:o=>z(parseFloat(o.target.value)),className:"sync-slider"})]}),J&&s.jsx("button",{className:`control-btn ${E?"active":""}`,onClick:()=>{var M,q;const o=!E;re(o),t.current&&(t.current.currentTime=Math.max(0,(((M=f.current)==null?void 0:M.currentTime)||0)+K.current),o&&!((q=f.current)!=null&&q.paused)?t.current.play().catch(()=>{}):t.current.pause())},disabled:!w,children:E?"ðŸ”‡ MUTE REF":"ðŸ”ˆ PLAY REF"})]}),s.jsxs("div",{className:"song-info",children:[s.jsx("h3",{children:l.name||l.song_name||l.title||"Untitled Song"}),s.jsxs("div",{className:"song-metadata",children:[((Se=l.reference_data)==null?void 0:Se.tempo)&&s.jsxs("span",{className:"metadata-item",children:["â™© ",Math.round(l.reference_data.tempo)," BPM"]}),((ye=l.reference_data)==null?void 0:ye.key)&&s.jsxs("span",{className:"metadata-item",children:["ðŸŽ¹ ",l.reference_data.key]}),((Ne=l.reference_data)==null?void 0:Ne.duration)&&s.jsxs("span",{className:"metadata-item",children:["â±ï¸ ",Math.floor(l.reference_data.duration/60),":",String(Math.floor(l.reference_data.duration%60)).padStart(2,"0")]})]})]})]}),J&&s.jsx("audio",{ref:t,src:J,crossOrigin:"anonymous"})]}):s.jsx("div",{className:"video-karaoke-player",children:s.jsx("div",{className:"no-song",children:s.jsx("p",{children:"No song selected"})})})},$e=({referenceData:l,externalTime:m,isSessionActive:g,onSessionComplete:u})=>{const N=n.useRef(null),S=n.useRef(null),a=n.useRef(null),f=n.useRef(null),O=n.useRef(g);n.useEffect(()=>{O.current=g},[g]);const[I,D]=n.useState({total:0,pitch:0,energy:0}),[T,h]=n.useState({frequency:0,confidence:0,centsError:0,combo:0,energyMatch:0}),p=n.useRef({pitchSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,currentCombo:0,frequencies:[],energies:[]}),b=n.useRef(null),$=n.useRef(!1),w=n.useRef({detectedOffset:0,confidence:0,samples:[]}),X=n.useRef({minEnergySeen:1/0,maxEnergySeen:0,initialized:!1}),j=n.useRef({centsErrorBuffer:[],maxBufferSize:10}),i=n.useRef(g),t={PITCH_WEIGHT:.3,ENERGY_WEIGHT:.7,PITCH_PERFECT_CENTS:50,PITCH_GOOD_CENTS:100,PITCH_ACCEPTABLE_CENTS:200,KEY_SHIFT_MIN_SAMPLES:10,KEY_SHIFT_TOLERANCE:100,KEY_SHIFT_MAX_OFFSET:200,ENERGY_MIN_THRESHOLD:.005,ENERGY_SMOOTHING_WINDOW:5,COMBO_THRESHOLD:.95,COMBO_BREAK_THRESHOLD:.6,EMA_ALPHA:.2,BACKBUFFER_MS:350,PITCH_FLOOR:.15,ENERGY_FLOOR:.1,MIN_CONFIDENCE:.2,LOW_CONFIDENCE_FLOOR:.3},E=n.useCallback(async()=>{try{console.log("Initializing audio processing..."),S.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3,latencyHint:"interactive"});const e=S.current;e.state==="suspended"&&(await e.resume(),console.log("Audio context resumed from suspended state"));try{await e.audioWorklet.addModule("/workers/pitch-processor.js"),console.log("âœ… AudioWorklet loaded successfully")}catch(d){console.warn("Failed to load AudioWorklet, using fallback:",d),console.log("Continuing without AudioWorklet - basic audio processing only")}const r=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!1,sampleRate:48e3,channelCount:1}}).catch(async d=>(console.warn("Failed to get microphone with constraints, trying fallback:",d),await navigator.mediaDevices.getUserMedia({audio:!0})));f.current=r;const c=e.createMediaStreamSource(r);try{const d=new AudioWorkletNode(e,"pitch-processor");a.current=d,d.port.onmessage=v=>{v.data.type==="audio-data"&&re(v.data)},c.connect(d),console.log("âœ… AudioWorklet processing initialized")}catch(d){console.warn("AudioWorklet failed, using basic audio monitoring:",d);const v=e.createAnalyser();c.connect(v);const x=setInterval(()=>{O.current?re({frequency:440,confidence:.8,energy:.5,centroid:1e3,aecReduction:.1,timestamp:Date.now()}):clearInterval(x)},100);console.log("âœ… Basic audio monitoring initialized")}}catch(e){console.error("Failed to initialize audio:",e),e.name==="NotAllowedError"?alert("Microphone access denied. Please allow microphone access and refresh the page."):e.name==="NotFoundError"?alert("No microphone found. Please connect a microphone and refresh the page."):e.name==="NotSupportedError"?alert("AudioWorklet not supported. Please use HTTPS or a modern browser (Chrome, Firefox, Safari)."):alert(`Audio initialization failed: ${e.message}. Please check your microphone and browser settings.`),h(r=>({...r,frequency:0,confidence:0,error:e.message}))}},[]),re=n.useCallback(e=>{if(console.log("ðŸŽ¤ Audio data received:",e),!O.current||!l){console.log("Session not active or no reference data");return}const{frequency:r,confidence:c,energy:d,centroid:v,aecReduction:x}=e,C=m,y=V(C);if(!y)return;const A=r>0&&c>=t.MIN_CONFIDENCE&&y.f0>0,R=A?ae(r,c,y,C):null,G=A?J(d,y):null,L=R===null?0:t.PITCH_WEIGHT,U=G===null?0:t.ENERGY_WEIGHT,W=L+U,F=W>0?((R??0)*L+(G??0)*U)/W:null;F!==null&&B(F);const H=1e4;p.current.pitchSamples.push(R),p.current.energySamples.push(G),p.current.timestamps.push(C),p.current.frequencies.push(r),p.current.energies.push(d),p.current.pitchSamples.length>H&&(p.current.pitchSamples.shift(),p.current.energySamples.shift(),p.current.timestamps.shift(),p.current.frequencies.shift(),p.current.energies.shift());const k=Q(r,y.f0);h(Y=>({frequency:r,confidence:c,centsError:k,combo:Y.combo,energyMatch:G})),D(Y=>({total:F!==null?ee(Y.total,F*100,t.EMA_ALPHA):Y.total,pitch:R!==null?ee(Y.pitch,R*100,t.EMA_ALPHA):Y.pitch,energy:G!==null?ee(Y.energy,G*100,t.EMA_ALPHA):Y.energy}))},[l,m]),V=n.useCallback(e=>{if(!l||!l.f0_ref_on_k)return null;const r=l.fps||50,c=Math.floor(e*r);if(c<0||c>=l.f0_ref_on_k.length)return null;const d=l.f0_ref_on_k[c],v=l.beats_k||[],x=v.reduce((A,R)=>Math.abs(R-e)<Math.abs(A-e)?R:A,v[0]||0),C=l.loudness_ref||[],y=C[Math.floor(c*C.length/l.f0_ref_on_k.length)];return{f0:(d==null?void 0:d.f0)||0,conf:(d==null?void 0:d.conf)||0,nearestBeat:x,beatDistance:Math.abs(e-x),loudness:(y==null?void 0:y.LUFS)||-30}},[l]),z=(e,r,c)=>1/(1+Math.exp(-(e-r)/c)),K=e=>{const r=z(e,.3,.1);return t.PITCH_FLOOR+r*(1-t.PITCH_FLOOR)},ae=n.useCallback((e,r,c,d)=>{const v=z(e,20,10),x=z(c.f0,20,10),C=v*x,y=Math.max(e,.1),A=Math.max(c.f0,.1);let R=Q(y,A);w.current.samples.push(R);const G=20;if(w.current.samples.length>G&&w.current.samples.shift(),w.current.samples.length>t.KEY_SHIFT_MIN_SAMPLES){const de=me(w.current.samples),oe=Math.tanh((Math.abs(de)-t.KEY_SHIFT_TOLERANCE)/50);oe>0&&(R-=de*Math.max(0,oe))}j.current.centsErrorBuffer.push(R),j.current.centsErrorBuffer.length>j.current.maxBufferSize&&j.current.centsErrorBuffer.shift();const L=me(j.current.centsErrorBuffer),U=Math.abs(L),W=220,F=Math.exp(-U/W),H=t.PITCH_FLOOR+(1-t.PITCH_FLOOR)*F,k=K(r);return H*k*C+t.PITCH_FLOOR*(1-C)},[]),J=n.useCallback((e,r)=>{const c=X.current;c.initialized||(c.minEnergySeen=Math.max(e,1e-6),c.maxEnergySeen=Math.max(e,1e-6),c.initialized=!0);const d=.05;e>c.maxEnergySeen&&(c.maxEnergySeen=e),e>1e-6&&e<c.minEnergySeen&&(c.minEnergySeen=c.minEnergySeen*(1-d)+e*d);const v=1e-10,x=Math.log10(e+v),C=Math.log10(c.minEnergySeen+v),y=Math.log10(c.maxEnergySeen+v),A=Math.max(y-C,.01);let R=(x-C)/A;R=Math.tanh(R*2);const G=t.ENERGY_FLOOR+(1-t.ENERGY_FLOOR)*(R+1)/2,L=z(e,t.ENERGY_MIN_THRESHOLD,.002);return t.ENERGY_FLOOR*(1-L)+G*L},[]),Q=(e,r)=>e===0||r===0?0:1200*Math.log2(e/r),B=e=>{if(e>=t.COMBO_THRESHOLD){if($.current)return;b.current&&(clearTimeout(b.current),b.current=null);const r=p.current.currentCombo+1;p.current.currentCombo=r,p.current.combos.push(r),p.current.maxCombo=Math.max(p.current.maxCombo,r),h(c=>({...c,combo:r}))}else p.current.currentCombo>0&&(p.current.currentCombo=0,$.current=!0,b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{h(r=>({...r,combo:0})),$.current=!1,b.current=null},1500)),p.current.combos.push(0)},ee=(e,r,c)=>c*r+(1-c)*e,me=e=>{if(e.length===0)return 0;const r=[...e].sort((d,v)=>d-v),c=Math.floor(r.length/2);return r.length%2===0?(r[c-1]+r[c])/2:r[c]};n.useEffect(()=>{const e=N.current;if(!e)return;const r=e.getContext("2d",{alpha:!1}),c=e.width,d=e.height;let v=null,x=0;const y=1e3/30,A=R=>{R-x>=y&&(r.fillStyle="#000",r.fillRect(0,0,c,d),ge(r,c,d),Se(r,c,d),ye(r,c,d),Ne(r),x=R),v=requestAnimationFrame(A)};return v=requestAnimationFrame(A),()=>{v!==null&&cancelAnimationFrame(v)}},[T,I,l,m]);const ge=(e,r,c)=>{const d=c*.35,v=c*.38,x=30,C=r-60,y=r/2;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(x,d,C,v),e.strokeStyle="rgba(0, 255, 255, 0.2)",e.lineWidth=1;const A=[82.4,164.8,329.6,659.2];for(let _ of A){const P=le(_,d,v);e.beginPath(),e.moveTo(x,P),e.lineTo(x+C,P),e.stroke()}if(e.strokeStyle="#0ff",e.lineWidth=2,e.strokeRect(x,d,C,v),!l||!l.f0_ref_on_k)return;const R=3,G=.5,L=m,U=L-G,W=L+R,F=l.f0_ref_on_k;let H=0,k=F.length;for(;H<k;){const _=H+k>>1;F[_].t<U?H=_+1:k=_}k=F.length;let Y=H;for(;Y<k;){const _=Y+k>>1;F[_].t<=W?Y=_+1:k=_}const de=[];for(let _=H;_<k;_++){const P=F[_];P.f0>0&&P.conf>.3&&de.push(P)}const oe=[];let ne=null;const _e=1200;for(let _=0;_<de.length;_++){const P=de[_];if(!ne)ne={startTime:P.t,endTime:P.t,f0:P.f0,conf:P.conf};else{const se=P.t-ne.endTime,ue=Math.abs(_e*Math.log2(P.f0/ne.f0));se<.1&&ue<50?(ne.endTime=P.t,ne.f0=(ne.f0+P.f0)*.5):(oe.push(ne),ne={startTime:P.t,endTime:P.t,f0:P.f0,conf:P.conf})}}ne&&oe.push(ne),oe.forEach(_=>{const P=le(_.f0,d,v),se=8,ue=_.startTime-L,xe=C/(R+G),ve=y+ue*xe,Oe=_.endTime-_.startTime,Ce=Math.max(4,Oe*xe),je=_.startTime<=L&&_.endTime>=L,Ae=Math.abs(_.startTime-L)<.2;if(ve+Ce>=x&&ve<=x+C){je?(e.fillStyle="#ff0",e.shadowBlur=15,e.shadowColor="#ff0"):Ae?(e.fillStyle="#f0f",e.shadowBlur=10,e.shadowColor="#f0f"):(e.fillStyle="rgba(0, 255, 255, 0.6)",e.shadowBlur=0);const Z=Math.max(x,ve),fe=Math.min(Ce,x+C-Z),te=P-se/2,ie=2;e.beginPath(),e.moveTo(Z+ie,te),e.lineTo(Z+fe-ie,te),e.quadraticCurveTo(Z+fe,te,Z+fe,te+ie),e.lineTo(Z+fe,te+se-ie),e.quadraticCurveTo(Z+fe,te+se,Z+fe-ie,te+se),e.lineTo(Z+ie,te+se),e.quadraticCurveTo(Z,te+se,Z,te+se-ie),e.lineTo(Z,te+ie),e.quadraticCurveTo(Z,te,Z+ie,te),e.closePath(),e.fill(),e.shadowBlur=0,e.strokeStyle=je?"#fff":"rgba(0, 255, 255, 0.8)",e.lineWidth=je?2:1,e.stroke()}}),e.strokeStyle="#fff",e.lineWidth=2,e.setLineDash([5,5]),e.beginPath(),e.moveTo(y,d),e.lineTo(y,d+v),e.stroke(),e.setLineDash([]);const pe=d+v+12;if(e.font="9px monospace",e.textAlign="center",e.fillStyle="#0f0",e.beginPath(),e.arc(y-60,pe,5,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.textAlign="left",e.fillText("= YOU",y-53,pe+3),e.strokeStyle="#f0f",e.lineWidth=2,e.beginPath(),e.moveTo(y+20,pe),e.lineTo(y+35,pe),e.stroke(),e.fillStyle="#fff",e.fillText("= TARGET",y+38,pe+3),T.frequency>0&&T.confidence>.2){const _=le(T.frequency,d,v),P=V(m);if(P&&P.f0>0){const ue=le(P.f0,d,v);e.strokeStyle=T.confidence>.5?"rgba(0, 255, 0, 0.5)":"rgba(255, 255, 0, 0.5)",e.lineWidth=2,e.beginPath(),e.moveTo(y,_),e.lineTo(y,ue),e.stroke(),e.strokeStyle="#f0f",e.fillStyle="#f0f",e.shadowBlur=12,e.shadowColor="#f0f",e.lineWidth=3,e.beginPath(),e.moveTo(y-25,ue),e.lineTo(y+25,ue),e.stroke(),e.font="bold 11px monospace",e.textAlign="left",e.fillText("TARGET",y+30,ue+4),e.shadowBlur=0}const se=T.confidence>.5?"#0f0":"#ff0";e.fillStyle=se,e.strokeStyle="#fff",e.shadowBlur=15,e.shadowColor=se,e.beginPath(),e.arc(y,_,10,0,Math.PI*2),e.fill(),e.lineWidth=2,e.stroke(),e.font="bold 11px monospace",e.textAlign="right",e.fillStyle=se,e.fillText("YOU",y-15,_+4),e.shadowBlur=0}},le=(e,r,c)=>{const x=Math.max(80,Math.min(1e3,e)),C=Math.log2(x),y=Math.log2(80),A=Math.log2(1e3),R=(C-y)/(A-y);return r+c*(1-R)},Se=(e,r,c)=>{const d=c*.78,v=r-60,x=18,C=30;e.fillStyle="#333",e.fillRect(C,d,v,x),e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.moveTo(r/2,d),e.lineTo(r/2,d+x),e.stroke();const y=50,A=T.centsError/y*(v/2),R=r/2+A,G=Math.abs(T.centsError);let L="#0f0";G>25&&(L="#ff0"),G>50&&(L="#f00"),e.fillStyle=L,e.fillRect(R-3,d,6,x),e.fillStyle="#fff",e.font="11px monospace",e.textAlign="center",e.fillText(`${T.centsError.toFixed(0)} Â¢`,r/2,d+x+15)},ye=(e,r,c)=>{T.combo>=2&&(e.fillStyle="#ff0",e.font="bold 32px monospace",e.textAlign="center",e.fillText(`${T.combo}x`,r/2,c*.12),e.font="bold 20px monospace",e.fillText("COMBO!",r/2,c*.16))},Ne=(e,r,c)=>{const x=y=>y>=90?"#0f0":y>=75?"#0ff":y>=60?"#ff0":"#f80",C=(y,A,R,G)=>{e.font="bold 12px monospace",e.fillStyle="#888",e.textAlign="left",e.fillText(y,15,R-8);const L=G||x(A);e.shadowBlur=15,e.shadowColor=L,e.font="bold 32px monospace",e.fillStyle=L,e.fillText(`${A.toFixed(0)}%`,15,R+20),e.shadowBlur=0;const U=120,W=6,F=15,H=R+26;e.fillStyle="#222",e.fillRect(F,H,U,W);const k=e.createLinearGradient(F,H,F+U,H);A>=90?(k.addColorStop(0,"#0f0"),k.addColorStop(1,"#0ff")):A>=75?(k.addColorStop(0,"#0ff"),k.addColorStop(1,"#08f")):A>=60?(k.addColorStop(0,"#ff0"),k.addColorStop(1,"#f80")):(k.addColorStop(0,"#f80"),k.addColorStop(1,"#f00")),e.fillStyle=k;const Y=A/100*U;e.fillRect(F,H,Y,W),e.strokeStyle=L,e.lineWidth=1,e.strokeRect(F,H,U,W)};e.font="bold 14px monospace",e.fillStyle="#fff",e.textAlign="left",e.fillText("TOTAL SCORE",15,30),e.shadowBlur=20,e.shadowColor=x(I.total),e.font="bold 42px monospace",e.fillStyle=x(I.total),e.fillText(`${I.total.toFixed(0)}%`,15,30+38),e.shadowBlur=0,e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.moveTo(15,30+50),e.lineTo(15+140,30+50),e.stroke(),C("PITCH",I.pitch,30+70,null),C("ENERGY",I.energy,30+125,null)},o=n.useCallback(e=>e.filter(r=>typeof r=="number"&&Number.isFinite(r)),[]),M=n.useCallback(e=>{const r=o(e);return r.length===0?0:r.reduce((c,d)=>c+d,0)/r.length},[o]),q=n.useCallback(e=>{const r=o(e);if(r.length===0)return 0;const c=M(r),d=r.reduce((v,x)=>v+Math.pow(x-c,2),0)/r.length;return Math.sqrt(d)},[o,M]),ce=n.useCallback(()=>{const e=p.current;if(e.timestamps.length===0)return console.warn("No performance data collected"),null;const r=M(e.pitchSamples)*100,c=M(e.energySamples)*100,d=r*t.PITCH_WEIGHT+c*t.ENERGY_WEIGHT,v=e.timestamps.map((W,F)=>{const H=e.pitchSamples[F];return typeof H!="number"?null:{time:W,score:H*100}}).filter(Boolean),x=e.timestamps.map((W,F)=>({time:W,energy:e.energies[F]})),C=[];e.maxCombo>=5&&C.push({name:"Combo King",description:`${e.maxCombo}x combo streak!`});const y=e.energySamples.length>0?1-q(e.energySamples)/(M(e.energySamples)+.001):0,A=M(e.energySamples);y>=.5&&A>=.8&&C.push({name:"Mic Melter",description:"Sustained energy!"}),(e.pitchSamples.length>0?1-q(e.pitchSamples)/(M(e.pitchSamples)+.001):0)>=.65&&r>=65&&C.push({name:"Smooth Operator",description:"Consistent pitch!"});const G=[],L=10,U=Math.max(...e.timestamps);for(let W=0;W<U;W+=L){const F=Math.min(W+L,U),H=e.timestamps.map((k,Y)=>k>=W&&k<F?Y:-1).filter(k=>k>=0);if(H.length>0){const k=M(H.map(oe=>e.pitchSamples[oe]))*100,Y=M(H.map(oe=>e.energySamples[oe]))*100,de=k*t.PITCH_WEIGHT+Y*t.ENERGY_WEIGHT;G.push({phrase:Math.floor(W/L),start:W,end:F,pitchScore:k,energyScore:Y,totalScore:de})}}return{totals:{total:d,pitch:r,energy:c,motion:0},badges:C,graphs:{pitchTimeline:v,energyGraph:x},perPhrase:G,performance_data:e}},[]);return n.useEffect(()=>{if(i.current&&!g&&p.current.timestamps.length>0){console.log("ðŸŽ¤ Session ended, computing final results...");const e=ce();e&&u&&(console.log("ðŸŽ¤ Final results:",e),u(e))}i.current=g},[g,ce,u]),n.useEffect(()=>(O.current?(console.log("ðŸŽ¤ Session active, initializing audio processing..."),i.current||(console.log("ðŸŽ¤ Resetting performance data for new session"),p.current={pitchSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,currentCombo:0,frequencies:[],energies:[]},b.current&&(clearTimeout(b.current),b.current=null),$.current=!1,h(e=>({...e,combo:0})),w.current={detectedOffset:0,confidence:0,samples:[]},X.current={minEnergySeen:1/0,maxEnergySeen:0,initialized:!1},j.current={centsErrorBuffer:[],maxBufferSize:10}),S.current?(console.log("ðŸŽ¤ Audio context already exists, ensuring processing is active"),a.current?console.log("ðŸŽ¤ AudioWorklet is active"):(console.log("ðŸŽ¤ AudioWorklet not active, reinitializing..."),E())):E()):(console.log("ðŸŽ¤ Session inactive, stopping audio processing"),f.current&&(f.current.getTracks().forEach(e=>e.stop()),f.current=null),S.current&&S.current.state!=="closed"&&(S.current.close().catch(()=>{}),S.current=null),a.current=null,b.current&&(clearTimeout(b.current),b.current=null),$.current=!1),()=>{f.current&&f.current.getTracks().forEach(e=>e.stop()),S.current&&S.current.state!=="closed"&&S.current.close().catch(()=>{}),b.current&&(clearTimeout(b.current),b.current=null),$.current=!1}),[g,E]),s.jsxs("div",{className:"live-hud",children:[s.jsx("canvas",{ref:N,width:500,height:700,className:"hud-canvas"}),w.current.confidence>.5&&s.jsxs("div",{className:"key-shift-indicator",children:["Key shifted: ",w.current.detectedOffset>0?"+":"",w.current.detectedOffset.toFixed(0)," cents"]})]})};function qe({onComplete:l}){const[m,g]=n.useState(null),[u,N]=n.useState(0),[S,a]=n.useState(!1),f=n.useRef(null),O=n.useRef(null),I=n.useRef(null),D=n.useRef(null);n.useEffect(()=>()=>{D.current&&cancelAnimationFrame(D.current),I.current&&I.current.getTracks().forEach(i=>i.stop())},[]);const T=async()=>{try{const i=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});I.current=i,g(!0),h(i)}catch(i){console.error("Microphone access denied:",i),g(!1)}},h=i=>{try{f.current=new(window.AudioContext||window.webkitAudioContext),f.current.state==="suspended"&&f.current.resume().catch(()=>{}),O.current=f.current.createAnalyser(),O.current.fftSize=256,O.current.smoothingTimeConstant=.8,f.current.createMediaStreamSource(i).connect(O.current),p()}catch(t){console.error("Audio analysis setup failed:",t)}},p=()=>{const i=new Uint8Array(O.current.frequencyBinCount),t=new Uint8Array(O.current.fftSize),E=()=>{if(O.current){O.current.getByteFrequencyData(i),O.current.getByteTimeDomainData(t);let re=0;for(let B=0;B<i.length;B++)re+=i[B]*i[B];const V=Math.sqrt(re/i.length);let z=0;for(let B=0;B<t.length;B++){const ee=t[B]-128;z+=ee*ee}const K=Math.sqrt(z/t.length),ae=Math.max(V*.5,K),J=Math.min(ae/32,1),Q=Math.max(J,.02);N(Q),D.current=requestAnimationFrame(E)}};E()},b=()=>a(!0),$=()=>a(!1),w=()=>l(),X=()=>u<.1?"#ff3d00":u<.3?"#ffd700":u<.7?"#39ff14":"#ff00e6",j=()=>u<.1?"TOO QUIET":u<.3?"GETTING THERE":u<.7?"PERFECT":"TOO LOUD";return s.jsxs("div",{className:"mic-check-container",children:[s.jsxs("div",{className:"mic-check-header",children:[s.jsx("h2",{className:"neon-text",children:"ðŸŽ¤ MIC CHECK ðŸŽ¤"}),s.jsx("p",{children:"Let's make sure everything is working perfectly!"})]}),s.jsxs("div",{className:"mic-check-content",children:[s.jsxs("div",{className:"mic-section",children:[s.jsx("h3",{children:"Microphone"}),m===null&&s.jsx("button",{className:"retro-button large",onClick:T,children:"ðŸŽ¤ ENABLE MICROPHONE"}),m===!1&&s.jsxs("div",{className:"permission-denied",children:[s.jsx("p",{children:"âŒ Microphone access denied"}),s.jsx("p",{children:"Please allow microphone access to continue"}),s.jsx("button",{className:"retro-button",onClick:T,children:"TRY AGAIN"})]}),m===!0&&s.jsxs("div",{className:"mic-status",children:[s.jsx("div",{className:"audio-level-display",children:s.jsx("div",{className:"audio-level-bar",style:{height:`${u*100}%`,backgroundColor:X()}})}),s.jsxs("div",{className:"audio-level-info",children:[s.jsx("p",{className:`level-text ${j().replace(" ","-").toLowerCase()}`,children:j()}),s.jsxs("p",{className:"level-value",children:[(u*100).toFixed(0),"%"]})]}),s.jsx("div",{className:"mic-controls",children:S?s.jsx("button",{className:"retro-button",onClick:$,children:"â¹ï¸ STOP LISTENING"}):s.jsx("button",{className:"retro-button",onClick:b,children:"ðŸŽµ START LISTENING"})})]})]}),s.jsxs("div",{className:"instructions",children:[s.jsx("h4",{children:"Instructions:"}),s.jsxs("ul",{children:[s.jsx("li",{children:"ðŸŽ¤ Enable microphone and test your audio levels"}),s.jsx("li",{children:"ðŸŽµ Sing a few notes to test your setup"}),s.jsx("li",{children:"âœ¨ When ready, proceed to the live performance!"})]})]}),m===!0&&s.jsxs("div",{className:"proceed-section",children:[s.jsx("button",{className:"retro-button large proceed",onClick:w,disabled:u<.02,children:"ðŸš€ START PERFORMANCE"}),u<.02&&s.jsx("p",{className:"warning",children:"âš ï¸ Please test your microphone first"})]})]})]})}function De({apiBase:l,onBack:m,onNewSession:g}){const[u,N]=n.useState([]),[S,a]=n.useState(!0);n.useEffect(()=>{f()},[]);const f=n.useCallback(async()=>{try{const p=await(await fetch(`${l}/leaderboard?limit=20`)).json();N(p)}catch(h){console.error("Failed to load leaderboard:",h)}finally{a(!1)}},[l]),O=n.useCallback(h=>h===1?"ðŸ¥‡":h===2?"ðŸ¥ˆ":h===3?"ðŸ¥‰":`#${h}`,[]),I=n.useCallback(h=>h>=90?"#39ff14":h>=80?"#ffd700":h>=70?"#ff9500":"#ff3d00",[]),D=n.useCallback(h=>{const p=new Date(h);return p.toLocaleDateString()+" "+p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},[]),T=n.useMemo(()=>{if(u.length===0)return 0;const h=u.reduce((p,b)=>p+b.total_score,0);return Math.round(h/u.length)},[u]);return S?s.jsx("div",{className:"leaderboard-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"LOADING LEADERBOARD..."})]})}):s.jsxs("div",{className:"leaderboard-container",children:[s.jsxs("div",{className:"leaderboard-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸ† LEADERBOARD ðŸ†"}),s.jsx("p",{className:"leaderboard-subtitle",children:"Top performers in the arcade!"})]}),s.jsx("div",{className:"leaderboard-content",children:u.length===0?s.jsxs("div",{className:"empty-leaderboard",children:[s.jsx("h2",{children:"ðŸŽ¤ NO SCORES YET"}),s.jsx("p",{children:"Be the first to submit a score!"}),s.jsx("button",{className:"retro-button large",onClick:g,children:"START SINGING"})]}):s.jsx("div",{className:"leaderboard-list",children:u.map((h,p)=>s.jsxs("div",{className:`leaderboard-entry ${p<3?"top-three":""}`,children:[s.jsx("div",{className:"rank",children:s.jsx("span",{className:"rank-icon",children:O(p+1)})}),s.jsxs("div",{className:"player-info",children:[s.jsx("h3",{className:"player-name",children:h.player_name}),s.jsx("p",{className:"play-date",children:D(h.played_at)})]}),s.jsxs("div",{className:"score-info",children:[s.jsx("div",{className:"total-score",style:{color:I(h.total_score)},children:Math.round(h.total_score)}),s.jsxs("div",{className:"score-breakdown",children:[s.jsxs("span",{children:["P: ",Math.round(h.pitch_score)]}),s.jsxs("span",{children:["E: ",Math.round(h.energy_score)]})]})]}),s.jsx("div",{className:"badges",children:h.badges&&h.badges.length>0&&s.jsx("div",{className:"badge-list",children:h.badges.map((b,$)=>s.jsxs("span",{className:"badge-mini",children:[b.name==="Combo King"&&"ðŸ‘‘",b.name==="Mic Melter"&&"ðŸ”¥",b.name==="Smooth Operator"&&"ðŸŽµ"]},$))})})]},h.id))})}),s.jsxs("div",{className:"leaderboard-actions",children:[s.jsx("button",{className:"retro-button",onClick:m,children:"â† BACK TO RESULTS"}),s.jsx("button",{className:"retro-button",onClick:g,children:"ðŸŽµ NEW SONG"}),s.jsx("button",{className:"retro-button",onClick:f,children:"ðŸ”„ REFRESH"})]}),s.jsxs("div",{className:"leaderboard-stats",children:[s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"TOTAL PLAYERS"}),s.jsx("span",{className:"stat-value",children:u.length})]}),s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"HIGHEST SCORE"}),s.jsx("span",{className:"stat-value",children:u.length>0?Math.round(u[0].total_score):0})]}),s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"AVERAGE SCORE"}),s.jsx("span",{className:"stat-value",children:T})]})]})]})}function Ve({sessionId:l,results:m,apiBase:g,onNewSession:u,playerName:N,onPlayerNameChange:S}){const[a,f]=n.useState(m||null),[O,I]=n.useState(!m&&!!l),[D,T]=n.useState(!1),[h,p]=n.useState(!1),b=n.useCallback(async()=>{try{const E=await(await fetch(`${g}/sessions/${l}/results`)).json();f(E.results||E)}catch(t){console.error("Failed to load results:",t)}finally{I(!1)}},[g,l]);n.useEffect(()=>{m?(f(m),I(!1)):l&&b()},[l,m,b]);const $=n.useCallback(async()=>{if(!N.trim()){alert("Please enter your name!");return}try{(await fetch(`${g}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:l,player_name:N,scores:a.totals,badges:a.badges})})).ok&&(p(!0),T(!0))}catch(t){console.error("Failed to submit to leaderboard:",t),alert("Failed to submit to leaderboard")}},[g,l,N,a]),w=n.useCallback(t=>t>=90?"#39ff14":t>=70?"#ffd700":t>=50?"#ff9500":"#ff3d00",[]),X=n.useCallback(t=>t>=95?"S+":t>=90?"S":t>=85?"A+":t>=80?"A":t>=75?"B+":t>=70?"B":t>=65?"C+":t>=60?"C":t>=50?"D":"F",[]),j=n.useMemo(()=>{var ae;if(!((ae=a==null?void 0:a.graphs)!=null&&ae.pitchTimeline))return null;const t=a.graphs.pitchTimeline;if(t.length===0)return null;const E=t.map(J=>J.time||0),re=Math.max(...E)||1,V=Math.min(...E)||0,z=re-V,K=z<2;return t.map((J,Q)=>{const B=K?Q/(t.length-1||1)*1e3:(J.time-V)/z*1e3,ee=90-(J.score||0)/100*80;return{x:B,y:ee,index:Q}})},[a]),i=n.useMemo(()=>{var Q;if(!((Q=a==null?void 0:a.graphs)!=null&&Q.energyGraph))return null;const t=a.graphs.energyGraph;if(t.length===0)return null;const E=t.map(B=>B.time||0),re=t.map(B=>B.energy||0),V=Math.max(...E)||1,z=Math.min(...E)||0,K=V-z,ae=Math.max(...re)||1,J=K<2;return t.map((B,ee)=>{const me=J?ee/(t.length-1||1)*1e3:(B.time-z)/K*1e3,le=90-(B.energy||0)/ae*80;return`${me},${le}`}).join(" ")},[a]);return O?s.jsx("div",{className:"results-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"CALCULATING RESULTS..."})]})}):a?s.jsx("div",{className:"results-container",children:D?s.jsx(De,{apiBase:g,onBack:()=>T(!1),onNewSession:u}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"results-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ PERFORMANCE COMPLETE! ðŸŽ¤"}),s.jsxs("div",{className:"final-score",children:[s.jsx("span",{className:"score-label",children:"FINAL SCORE"}),s.jsx("span",{className:"score-value",style:{color:w(a.totals.total)},children:Math.round(a.totals.total)}),s.jsx("span",{className:"score-grade",style:{color:w(a.totals.total)},children:X(a.totals.total)})]})]}),s.jsxs("div",{className:"score-breakdown",children:[s.jsx("h2",{children:"SCORE BREAKDOWN"}),s.jsxs("div",{className:"score-grid",children:[s.jsxs("div",{className:"score-item",children:[s.jsx("span",{className:"score-label",children:"PITCH"}),s.jsx("div",{className:"score-bar",children:s.jsx("div",{className:"score-fill pitch",style:{width:`${a.totals.pitch}%`}})}),s.jsx("span",{className:"score-value",children:Math.round(a.totals.pitch)})]}),s.jsxs("div",{className:"score-item",children:[s.jsx("span",{className:"score-label",children:"ENERGY"}),s.jsx("div",{className:"score-bar",children:s.jsx("div",{className:"score-fill energy",style:{width:`${a.totals.energy}%`}})}),s.jsx("span",{className:"score-value",children:Math.round(a.totals.energy)})]})]})]}),a.badges&&a.badges.length>0&&s.jsxs("div",{className:"badges-section",children:[s.jsx("h2",{children:"ðŸ† BADGES EARNED ðŸ†"}),s.jsx("div",{className:"badges-grid",children:a.badges.map((t,E)=>s.jsxs("div",{className:"badge",children:[s.jsxs("div",{className:"badge-icon",children:[t.name==="Combo King"&&"ðŸ‘‘",t.name==="Mic Melter"&&"ðŸ”¥",t.name==="Smooth Operator"&&"ðŸŽµ"]}),s.jsxs("div",{className:"badge-info",children:[s.jsx("h3",{children:t.name}),s.jsx("p",{children:t.description})]})]},E))})]}),a.graphs&&s.jsxs("div",{className:"charts-section",children:[s.jsx("h2",{children:"ðŸ“Š PERFORMANCE ANALYSIS"}),s.jsxs("div",{className:"chart-container",children:[s.jsx("h3",{children:"Pitch Timeline"}),s.jsx("div",{className:"chart",children:s.jsx("svg",{width:"100%",height:"200",viewBox:"0 0 1000 100",preserveAspectRatio:"none",className:"pitch-chart",children:j==null?void 0:j.map(t=>s.jsx("circle",{cx:t.x,cy:t.y,r:"3",fill:"#39ff14",opacity:"0.7"},t.index))})})]}),s.jsxs("div",{className:"chart-container",children:[s.jsx("h3",{children:"Energy Graph"}),s.jsx("div",{className:"chart",children:s.jsx("svg",{width:"100%",height:"200",viewBox:"0 0 1000 100",preserveAspectRatio:"none",className:"energy-chart",children:i&&s.jsx("polyline",{points:i,fill:"none",stroke:"#ff00e6",strokeWidth:"2"})})})]})]}),a.perPhrase&&a.perPhrase.length>0&&s.jsxs("div",{className:"phrases-section",children:[s.jsx("h2",{children:"ðŸŽµ PHRASE BREAKDOWN"}),s.jsx("div",{className:"phrases-grid",children:a.perPhrase.map((t,E)=>s.jsxs("div",{className:"phrase-item",children:[s.jsxs("div",{className:"phrase-header",children:[s.jsxs("span",{className:"phrase-number",children:["Phrase ",t.phrase+1]}),s.jsxs("span",{className:"phrase-time",children:[t.start.toFixed(1),"s - ",t.end.toFixed(1),"s"]})]}),s.jsxs("div",{className:"phrase-scores",children:[s.jsxs("span",{children:["Pitch: ",Math.round(t.pitchScore)]}),s.jsxs("span",{children:["Energy: ",Math.round(t.energyScore)]})]}),s.jsxs("div",{className:"phrase-total",children:["Total: ",Math.round(t.totalScore)]})]},E))})]}),!h&&s.jsxs("div",{className:"leaderboard-submission",children:[s.jsx("h2",{children:"ðŸ† SUBMIT TO LEADERBOARD"}),s.jsxs("div",{className:"submission-form",children:[s.jsx("input",{type:"text",placeholder:"Enter your name",value:N,onChange:t=>S(t.target.value),className:"name-input",maxLength:20}),s.jsx("button",{className:"retro-button large",onClick:$,disabled:!N.trim(),children:"SUBMIT SCORE"})]})]}),s.jsxs("div",{className:"results-actions",children:[s.jsx("button",{className:"retro-button",onClick:u,children:"ðŸŽµ NEW SONG"}),s.jsx("button",{className:"retro-button",onClick:()=>T(!0),children:"ðŸ“Š LEADERBOARD"})]})]})}):s.jsx("div",{className:"results-container",children:s.jsxs("div",{className:"error",children:[s.jsx("h2",{children:"âŒ RESULTS NOT FOUND"}),s.jsx("button",{className:"retro-button",onClick:u,children:"START NEW SESSION"})]})})}const he=window.location.port==="3000"?"http://localhost:8080":window.location.origin;function ze(){const[l,m]=n.useState("library"),[g,u]=n.useState(null),[N,S]=n.useState(null),[a,f]=n.useState(""),[O,I]=n.useState(0),[D,T]=n.useState(!1),[h,p]=n.useState(null),b=i=>{u(i),m("mic-check")},$=()=>{m("karaoke")},w=async i=>{try{N?(await fetch(`${he}/sessions/${N}/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).catch(t=>console.warn("Failed to save results to backend:",t)),a&&await fetch(`${he}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:N,player_name:a,scores:i.totals,badges:i.badges})}).catch(t=>console.warn("Failed to submit to leaderboard:",t))):console.warn("No session ID, results not saved to backend"),p(i),m("results")}catch(t){console.error("Error in handleSessionComplete:",t),p(i),m("results")}},X=()=>{m("library"),u(null),S(null),f(""),T(!1),p(null)},j=()=>{switch(l){case"library":return s.jsx(We,{onSongSelect:b,apiBase:he});case"mic-check":return s.jsx(qe,{onComplete:$});case"karaoke":return s.jsxs("div",{className:"karaoke-stage",children:[s.jsx(Ye,{songData:g,apiBase:he,onSessionComplete:w,onStartSession:async()=>{try{const i=await fetch(`${he}/sessions/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({song_id:g.id})});if(!i.ok){const E=await i.json();throw console.error("Failed to start session:",E),new Error(E.error||"Failed to start session")}const t=await i.json();S(t.session_id)}catch(i){console.error("Error starting session:",i),alert(`Failed to start session: ${i.message}`),T(!1)}},onTimeUpdate:i=>I(i),isSessionActive:D,onSessionToggle:i=>T(i)}),s.jsx($e,{referenceData:g==null?void 0:g.reference_data,externalTime:O,isSessionActive:D,onSessionComplete:w})]});case"results":return s.jsx(Ve,{sessionId:N,results:h,apiBase:he,onNewSession:X,playerName:a,onPlayerNameChange:f});default:return s.jsx("div",{children:"Unknown screen"})}};return s.jsxs("div",{className:"app",children:[s.jsx("header",{className:"app-header",children:s.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ PitchPerfectly ðŸŽ¤"})}),s.jsx("main",{className:"app-main",children:j()}),s.jsx("footer",{className:"app-footer",children:s.jsxs("div",{className:"controls",children:[s.jsx("button",{className:"retro-button",onClick:X,disabled:l==="library",children:"ðŸŽµ SONG LIBRARY"}),s.jsx("button",{className:"retro-button",onClick:()=>m("results"),disabled:!N,children:"ðŸ“Š LEADERBOARD"})]})})]})}const Re=document.querySelector(".loading-screen");Re&&(Re.style.display="none");Ee.createRoot(document.getElementById("root")).render(s.jsx(Le.StrictMode,{children:s.jsx(ze,{})}));
