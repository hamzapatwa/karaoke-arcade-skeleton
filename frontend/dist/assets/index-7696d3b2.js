import{r as a,a as fe,R as pe}from"./vendor-b1791c80.js";(function(){const p=document.createElement("link").relList;if(p&&p.supports&&p.supports("modulepreload"))return;for(const y of document.querySelectorAll('link[rel="modulepreload"]'))u(y);new MutationObserver(y=>{for(const x of y)if(x.type==="childList")for(const o of x.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&u(o)}).observe(document,{childList:!0,subtree:!0});function N(y){const x={};return y.integrity&&(x.integrity=y.integrity),y.referrerPolicy&&(x.referrerPolicy=y.referrerPolicy),y.crossOrigin==="use-credentials"?x.credentials="include":y.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function u(y){if(y.ep)return;y.ep=!0;const x=N(y);fetch(y.href,x)}})();var ue={exports:{}},ae={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var xe=a,ge=Symbol.for("react.element"),Ne=Symbol.for("react.fragment"),ye=Object.prototype.hasOwnProperty,je=xe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ve={key:!0,ref:!0,__self:!0,__source:!0};function he(i,p,N){var u,y={},x=null,o=null;N!==void 0&&(x=""+N),p.key!==void 0&&(x=""+p.key),p.ref!==void 0&&(o=p.ref);for(u in p)ye.call(p,u)&&!ve.hasOwnProperty(u)&&(y[u]=p[u]);if(i&&i.defaultProps)for(u in p=i.defaultProps,p)y[u]===void 0&&(y[u]=p[u]);return{$$typeof:ge,type:i,key:x,ref:o,props:y,_owner:je.current}}ae.Fragment=Ne;ae.jsx=he;ae.jsxs=he;ue.exports=ae;var e=ue.exports,oe={},ie=fe;oe.createRoot=ie.createRoot,oe.hydrateRoot=ie.hydrateRoot;function Se({onSongSelect:i,apiBase:p}){var d,E,v,b,P,m,L;const[N,u]=a.useState([]),[y,x]=a.useState(!0),[o,g]=a.useState(null);a.useState(!1),a.useEffect(()=>{S()},[]);const S=async()=>{try{const n=await(await fetch(`${p}/library`)).json();u(n)}catch(t){console.error("Failed to load library:",t)}finally{x(!1)}},R=async t=>{try{const n=await fetch(`${p}/library/${t.id}`);if(!n.ok){const A=await n.json().catch(()=>({}));console.error("Failed to load song details:",A.error||n.statusText),alert(`Failed to load song: ${A.error||n.statusText}`);return}const f=await n.json();g(f),i(f)}catch(n){console.error("Failed to load song details:",n),alert(`Failed to load song: ${n.message}`)}},O=t=>new Date(t).toLocaleDateString();return y?e.jsx("div",{className:"library-container",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("h2",{children:"LOADING LIBRARY..."})]})}):e.jsxs("div",{className:"library-container",children:[e.jsxs("div",{className:"library-header",children:[e.jsx("h1",{className:"neon-title",children:"ðŸŽµ SONG LIBRARY ðŸŽµ"}),e.jsx("div",{className:"library-controls",children:e.jsx("button",{className:"retro-button",onClick:S,children:"ðŸ”„ REFRESH"})})]}),e.jsx("div",{className:"library-content",children:N.length===0?e.jsxs("div",{className:"empty-library",children:[e.jsx("h2",{children:"ðŸŽ¤ NO SONGS IN LIBRARY"}),e.jsx("p",{children:"Place preprocessed references and videos to get started."})]}):e.jsx("div",{className:"songs-grid",children:N.map(t=>e.jsxs("div",{className:`song-card ${(o==null?void 0:o.id)===t.id?"selected":""}`,onClick:()=>R(t),children:[e.jsxs("div",{className:"song-info",children:[e.jsx("h3",{className:"song-title",children:t.name}),e.jsxs("p",{className:"song-date",children:["Added: ",O(t.uploaded_at)]}),e.jsx("div",{className:"song-status",children:e.jsx("span",{className:"status-badge ready",children:"âœ… READY"})})]}),e.jsx("div",{className:"song-actions",children:e.jsx("button",{className:"retro-button small",onClick:n=>{n.stopPropagation(),R(t)},children:"ðŸŽ¤ SING"})})]},t.id))})}),o&&e.jsxs("div",{className:"song-details",children:[e.jsxs("h3",{children:["Selected: ",o.name]}),e.jsxs("div",{className:"song-metadata",children:[e.jsxs("div",{className:"metadata-item",children:[e.jsx("span",{className:"label",children:"Duration:"}),e.jsxs("span",{className:"value",children:[(E=(d=o.reference_data)==null?void 0:d.duration)==null?void 0:E.toFixed(1),"s"]})]}),e.jsxs("div",{className:"metadata-item",children:[e.jsx("span",{className:"label",children:"Tempo:"}),e.jsxs("span",{className:"value",children:[(b=(v=o.reference_data)==null?void 0:v.tempo)==null?void 0:b.toFixed(1)," BPM"]})]}),e.jsxs("div",{className:"metadata-item",children:[e.jsx("span",{className:"label",children:"Key:"}),e.jsx("span",{className:"value",children:(P=o.reference_data)==null?void 0:P.key})]}),e.jsxs("div",{className:"metadata-item",children:[e.jsx("span",{className:"label",children:"Phrases:"}),e.jsx("span",{className:"value",children:(L=(m=o.reference_data)==null?void 0:m.phrases)==null?void 0:L.length})]})]})]})]})}const Ee=({songData:i,apiBase:p,onTimeUpdate:N,onStartSession:u,onSessionComplete:y,isSessionActive:x,onSessionToggle:o})=>{var ee,se,I;const g=a.useRef(null),[S,R]=a.useState(!1),[O,d]=a.useState(0),[E,v]=a.useState(0),[b,P]=a.useState(.7),[m,L]=a.useState(!1),t=a.useRef(null),n=a.useRef(x),f=a.useRef(null),[A,G]=a.useState(!1);a.useEffect(()=>{n.current=x},[x]);const $=i!=null&&i.karaoke_video?`${p}${i.karaoke_video.startsWith("/")?"":"/"}${i.karaoke_video}`:null,Y=i!=null&&i.reference_vocals?`${p}${i.reference_vocals.startsWith("/")?"":"/"}${i.reference_vocals}`:null,B=a.useCallback((h,k)=>{if(!g.current)return;const s=g.current,r=k?k.mediaTime:s.currentTime;d(r),N&&N(r),!s.paused&&!s.ended&&s.requestVideoFrameCallback&&(t.current=s.requestVideoFrameCallback(B))},[N]),W=a.useCallback(()=>{if(!g.current)return;const h=g.current;d(h.currentTime),N&&N(h.currentTime)},[N]);a.useEffect(()=>{const h=g.current;if(!h)return;const k=()=>{v(h.duration),L(!0),console.log("Video ready:",{duration:h.duration,videoWidth:h.videoWidth,videoHeight:h.videoHeight})},s=()=>{R(!0),h.requestVideoFrameCallback&&(t.current=h.requestVideoFrameCallback(B)),A&&f.current&&(f.current.currentTime=h.currentTime,f.current.play().catch(()=>{}))},r=()=>{R(!1),t.current!==null&&h.cancelVideoFrameCallback&&(h.cancelVideoFrameCallback(t.current),t.current=null),f.current&&!f.current.paused&&f.current.pause()},l=()=>{R(!1),n.current&&o&&o(!1),f.current&&(f.current.pause(),f.current.currentTime=0)};return h.addEventListener("loadedmetadata",k),h.addEventListener("play",s),h.addEventListener("pause",r),h.addEventListener("ended",l),h.addEventListener("timeupdate",W),()=>{h.removeEventListener("loadedmetadata",k),h.removeEventListener("play",s),h.removeEventListener("pause",r),h.removeEventListener("ended",l),h.removeEventListener("timeupdate",W),t.current!==null&&h.cancelVideoFrameCallback&&h.cancelVideoFrameCallback(t.current)}},[B,W,x,o,A]),a.useEffect(()=>{g.current&&(g.current.volume=b)},[b]);const K=a.useCallback(async()=>{const h=g.current;if(h)try{h.paused?(await h.play(),console.log("Video play started successfully")):(h.pause(),console.log("Video paused"))}catch(k){console.error("Video play/pause error:",k),alert(`Video playback error: ${k.message}`)}},[]),U=a.useCallback(h=>{const k=g.current;if(!k)return;const s=h.currentTarget.getBoundingClientRect(),c=(h.clientX-s.left)/s.width*E;k.currentTime=c,d(c),N&&N(c),f.current&&(f.current.currentTime=c,A&&!k.paused&&f.current.play().catch(()=>{}))},[E,N,A]),F=async()=>{if(n.current)o&&o(!1),g.current&&!g.current.paused&&g.current.pause(),f.current&&!f.current.paused&&f.current.pause();else if(u&&await u(),o&&o(!0),g.current&&g.current.paused)try{await g.current.play(),console.log("Auto-play started for session")}catch(h){console.error("Auto-play failed:",h),alert(`Auto-play failed: ${h.message}. Please click play manually.`)}},z=h=>{const k=Math.floor(h/60),s=Math.floor(h%60);return`${k}:${s.toString().padStart(2,"0")}`};return i?e.jsxs("div",{className:"video-karaoke-player",children:[e.jsxs("div",{className:"video-container",children:[e.jsx("video",{ref:g,className:"karaoke-video",src:$,crossOrigin:"anonymous",playsInline:!0,children:"Your browser does not support the video tag."}),e.jsx("div",{className:"video-overlay",children:e.jsx("button",{className:"play-pause-overlay",onClick:K,"aria-label":S?"Pause":"Play",children:S?"â¸ï¸":"â–¶ï¸"})})]}),e.jsxs("div",{className:"playback-controls",children:[e.jsxs("div",{className:"progress-section",children:[e.jsx("span",{className:"time-display",children:z(O)}),e.jsx("div",{className:"progress-bar",onClick:U,children:e.jsx("div",{className:"progress-fill",style:{width:`${O/E*100}%`}})}),e.jsx("span",{className:"time-display",children:z(E)})]}),e.jsxs("div",{className:"control-buttons",children:[e.jsx("button",{className:"control-btn",onClick:K,disabled:!m,children:S?"â¸ï¸ PAUSE":"â–¶ï¸ PLAY"}),e.jsx("button",{className:`control-btn ${x?"active":""}`,onClick:F,disabled:!m,children:x?"â¹ï¸ STOP SESSION":"ðŸŽ¤ START SESSION"}),e.jsxs("div",{className:"volume-control",children:[e.jsx("span",{className:"volume-icon",children:"ðŸ”Š"}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:b,onChange:h=>P(parseFloat(h.target.value)),className:"volume-slider"})]}),Y&&e.jsx("button",{className:`control-btn ${A?"active":""}`,onClick:()=>{var k,s;const h=!A;G(h),f.current&&(f.current.currentTime=((k=g.current)==null?void 0:k.currentTime)||0,h&&!((s=g.current)!=null&&s.paused)?f.current.play().catch(()=>{}):f.current.pause())},disabled:!m,children:A?"ðŸ”‡ MUTE REF VOCALS":"ðŸ”ˆ PLAY REF VOCALS"})]}),e.jsxs("div",{className:"song-info",children:[e.jsx("h3",{children:i.name||i.song_name||i.title||"Untitled Song"}),e.jsxs("div",{className:"song-metadata",children:[((ee=i.reference_data)==null?void 0:ee.tempo)&&e.jsxs("span",{className:"metadata-item",children:["â™© ",Math.round(i.reference_data.tempo)," BPM"]}),((se=i.reference_data)==null?void 0:se.key)&&e.jsxs("span",{className:"metadata-item",children:["ðŸŽ¹ ",i.reference_data.key]}),((I=i.reference_data)==null?void 0:I.duration)&&e.jsxs("span",{className:"metadata-item",children:["â±ï¸ ",Math.floor(i.reference_data.duration/60),":",String(Math.floor(i.reference_data.duration%60)).padStart(2,"0")]})]})]})]}),Y&&e.jsx("audio",{ref:f,src:Y,crossOrigin:"anonymous"})]}):e.jsx("div",{className:"video-karaoke-player",children:e.jsx("div",{className:"no-song",children:e.jsx("p",{children:"No song selected"})})})},be=({referenceData:i,externalTime:p,isSessionActive:N,onSessionComplete:u})=>{const y=a.useRef(null),x=a.useRef(null),o=a.useRef(null),g=a.useRef(null),S=a.useRef(N);a.useEffect(()=>{S.current=N},[N]);const[R,O]=a.useState({total:0,pitch:0,rhythm:0,energy:0}),[d,E]=a.useState({frequency:0,confidence:0,centsError:0,onBeat:!1,combo:0,energyMatch:0}),v=a.useRef({pitchSamples:[],rhythmSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,frequencies:[],energies:[],onBeatFlags:[]}),b=a.useRef({detectedOffset:0,confidence:0,samples:[]}),P=a.useRef(N),m={PITCH_WEIGHT:.65,RHYTHM_WEIGHT:.25,ENERGY_WEIGHT:.1,PITCH_PERFECT_CENTS:25,PITCH_GOOD_CENTS:50,PITCH_ACCEPTABLE_CENTS:100,KEY_SHIFT_MIN_SAMPLES:10,KEY_SHIFT_TOLERANCE:100,KEY_SHIFT_MAX_OFFSET:200,BEAT_PERFECT_MS:100,BEAT_GOOD_MS:200,BEAT_ACCEPTABLE_MS:400,ENERGY_TOLERANCE_DB:6,ENERGY_MIN_THRESHOLD:.01,COMBO_THRESHOLD:.7,COMBO_BREAK_THRESHOLD:.3,EMA_ALPHA:.3,BACKBUFFER_MS:250},L=a.useCallback(async()=>{try{console.log("Initializing audio processing with AEC..."),x.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3,latencyHint:"interactive"});const s=x.current;try{await s.audioWorklet.addModule("/workers/pitch-processor-aec.js"),console.log("âœ… AudioWorklet loaded successfully")}catch(c){console.warn("Failed to load AudioWorklet, using fallback:",c),console.log("Continuing without AudioWorklet - basic audio processing only")}const r=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!1,sampleRate:48e3,channelCount:1}}).catch(async c=>(console.warn("Failed to get microphone with constraints, trying fallback:",c),await navigator.mediaDevices.getUserMedia({audio:!0})));g.current=r;const l=s.createMediaStreamSource(r);try{const c=new AudioWorkletNode(s,"pitch-processor-aec");o.current=c,c.port.onmessage=j=>{j.data.type==="audio-data"&&t(j.data)},l.connect(c),c.connect(s.destination),console.log("âœ… AudioWorklet processing initialized")}catch(c){console.warn("AudioWorklet failed, using basic audio monitoring:",c),l.connect(s.destination);const j=setInterval(()=>{S.current?t({frequency:440,confidence:.8,energy:.5,centroid:1e3,aecReduction:.1,timestamp:Date.now()}):clearInterval(j)},100);console.log("âœ… Basic audio monitoring initialized")}}catch(s){console.error("Failed to initialize audio:",s),s.name==="NotAllowedError"?alert("Microphone access denied. Please allow microphone access and refresh the page."):s.name==="NotFoundError"?alert("No microphone found. Please connect a microphone and refresh the page."):s.name==="NotSupportedError"?alert("AudioWorklet not supported. Please use HTTPS or a modern browser (Chrome, Firefox, Safari)."):alert(`Audio initialization failed: ${s.message}. Please check your microphone and browser settings.`),E(r=>({...r,frequency:0,confidence:0,error:s.message}))}},[]),t=a.useCallback(s=>{if(console.log("ðŸŽ¤ Audio data received:",s),!S.current||!i){console.log("Session not active or no reference data");return}const{frequency:r,confidence:l,energy:c,centroid:j,aecReduction:C}=s,T=p,_=n(T);if(!_)return;const M=f(r,l,_,T),w=A(T,_),D=G(c,_),X=M*m.PITCH_WEIGHT+w*m.RHYTHM_WEIGHT+D*m.ENERGY_WEIGHT;Y(X),v.current.pitchSamples.push(M),v.current.rhythmSamples.push(w),v.current.energySamples.push(D),v.current.timestamps.push(T),v.current.frequencies.push(r),v.current.energies.push(c),v.current.onBeatFlags.push(w>.8);const te=$(r,_.f0);E({frequency:r,confidence:l,centsError:te,onBeat:w>.8,combo:v.current.maxCombo,energyMatch:D}),O(q=>({total:B(q.total,X*100,m.EMA_ALPHA),pitch:B(q.pitch,M*100,m.EMA_ALPHA),rhythm:B(q.rhythm,w*100,m.EMA_ALPHA),energy:B(q.energy,D*100,m.EMA_ALPHA)}))},[i,p]),n=a.useCallback(s=>{if(!i||!i.f0_ref_on_k)return null;const r=i.fps||50,l=Math.floor(s*r);if(l<0||l>=i.f0_ref_on_k.length)return null;const c=i.f0_ref_on_k[l],j=i.beats_k||[],C=j.reduce((M,w)=>Math.abs(w-s)<Math.abs(M-s)?w:M,j[0]||0),T=i.loudness_ref||[],_=T[Math.floor(l*T.length/i.f0_ref_on_k.length)];return{f0:(c==null?void 0:c.f0)||0,conf:(c==null?void 0:c.conf)||0,nearestBeat:C,beatDistance:Math.abs(s-C),loudness:(_==null?void 0:_.LUFS)||-30}},[i]),f=a.useCallback((s,r,l,c)=>{if(s===0||l.f0===0||r<.3)return 0;let j=$(s,l.f0);if(b.current.samples.push(j),b.current.samples.length>m.KEY_SHIFT_MIN_SAMPLES){b.current.samples.length>20&&b.current.samples.shift();const T=W(b.current.samples);Math.abs(T)>m.KEY_SHIFT_TOLERANCE&&Math.abs(T)<m.KEY_SHIFT_MAX_OFFSET&&(b.current.detectedOffset=T,b.current.confidence=.8,j-=T)}const C=Math.abs(j);return C<=m.PITCH_PERFECT_CENTS?1:C<=m.PITCH_GOOD_CENTS?.9-(C-m.PITCH_PERFECT_CENTS)*.02:C<=m.PITCH_ACCEPTABLE_CENTS?.7-(C-m.PITCH_GOOD_CENTS)*.01:Math.max(0,.5-(C-m.PITCH_ACCEPTABLE_CENTS)*.005)},[]),A=a.useCallback((s,r)=>{const l=r.beatDistance*1e3;return l<=m.BEAT_PERFECT_MS?1:l<=m.BEAT_GOOD_MS?.8:l<=m.BEAT_ACCEPTABLE_MS?.5:l<=1e3?.3:.1},[]),G=a.useCallback((s,r)=>{if(s<m.ENERGY_MIN_THRESHOLD)return .5;const l=20*Math.log10(s+1e-10),c=r.loudness||-30,j=Math.abs(l-c);return j<=m.ENERGY_TOLERANCE_DB?1:Math.max(0,1-(j-m.ENERGY_TOLERANCE_DB)*.05)},[]),$=(s,r)=>s===0||r===0?0:1200*Math.log2(s/r),Y=s=>{if(s>=m.COMBO_THRESHOLD){const r=(v.current.combos[v.current.combos.length-1]||0)+1;v.current.combos.push(r),v.current.maxCombo=Math.max(v.current.maxCombo,r)}else s<m.COMBO_BREAK_THRESHOLD&&v.current.combos.push(0)},B=(s,r,l)=>l*r+(1-l)*s,W=s=>{if(s.length===0)return 0;const r=[...s].sort((c,j)=>c-j),l=Math.floor(r.length/2);return r.length%2===0?(r[l-1]+r[l])/2:r[l]};a.useEffect(()=>{const s=y.current;if(!s)return;const r=s.getContext("2d"),l=s.width,c=s.height,j=()=>{r.fillStyle="#000",r.fillRect(0,0,l,c),K(r,l,c),F(r,l,c),z(r,l,c),ee(r,l,c),se(r),requestAnimationFrame(j)};j()},[d,R,i]);const K=(s,r,l)=>{var C;const c=l*.3,j=l*.4;if(s.strokeStyle="#0ff",s.lineWidth=2,s.strokeRect(50,c,r-100,j),i&&d.frequency>0){const T=((C=n(p))==null?void 0:C.f0)||0;if(T>0){const _=U(T,c,j);s.strokeStyle="#f0f",s.lineWidth=2,s.beginPath(),s.moveTo(50,_),s.lineTo(r-50,_),s.stroke();const M=U(d.frequency,c,j);s.fillStyle=d.confidence>.5?"#0f0":"#ff0",s.beginPath(),s.arc(r/2,M,10,0,Math.PI*2),s.fill()}}},U=(s,r,l)=>{const C=Math.log2(s),T=Math.log2(100),_=Math.log2(800),M=(C-T)/(_-T);return r+l*(1-M)},F=(s,r,l)=>{const c=l*.75,j=400,C=20,T=(r-j)/2;s.fillStyle="#333",s.fillRect(T,c,j,C),s.strokeStyle="#fff",s.lineWidth=2,s.beginPath(),s.moveTo(r/2,c),s.lineTo(r/2,c+C),s.stroke();const _=50,M=d.centsError/_*(j/2),w=r/2+M,D=Math.abs(d.centsError);let X="#0f0";D>25&&(X="#ff0"),D>50&&(X="#f00"),s.fillStyle=X,s.fillRect(w-3,c,6,C),s.fillStyle="#fff",s.font="14px monospace",s.textAlign="center",s.fillText(`${d.centsError.toFixed(0)} Â¢`,r/2,c+C+20)},z=(s,r,l)=>{const c=l*.85,j=20,C=30,T=8;for(let _=0;_<T;_++){const M=r/2-T*C/2+_*C,w=d.onBeat&&_%2===0;s.fillStyle=w?"#0f0":"#333",s.beginPath(),s.arc(M,c,j/2,0,Math.PI*2),s.fill(),w&&(s.strokeStyle="#0ff",s.lineWidth=2,s.stroke())}},ee=(s,r,l)=>{d.combo>5&&(s.fillStyle="#ff0",s.font="bold 48px monospace",s.textAlign="center",s.fillText(`${d.combo}x COMBO!`,r/2,l*.15))},se=(s,r,l)=>{s.fillStyle="#0ff",s.font="bold 24px monospace",s.textAlign="left";const c=20,j=30;s.fillText(`TOTAL: ${R.total.toFixed(0)}%`,c,j),s.fillText(`PITCH: ${R.pitch.toFixed(0)}%`,c,j+30),s.fillText(`RHYTHM: ${R.rhythm.toFixed(0)}%`,c,j+60),s.fillText(`ENERGY: ${R.energy.toFixed(0)}%`,c,j+90)},I=s=>s.length===0?0:s.reduce((r,l)=>r+l,0)/s.length,h=s=>{if(s.length===0)return 0;const r=I(s),l=s.reduce((c,j)=>c+Math.pow(j-r,2),0)/s.length;return Math.sqrt(l)},k=a.useCallback(()=>{const s=v.current;if(s.timestamps.length===0)return console.warn("No performance data collected"),null;const r=I(s.pitchSamples)*100,l=I(s.rhythmSamples)*100,c=I(s.energySamples)*100,j=r*m.PITCH_WEIGHT+l*m.RHYTHM_WEIGHT+c*m.ENERGY_WEIGHT,C=s.timestamps.map((H,V)=>({time:H,score:s.pitchSamples[V]*100})),T=s.timestamps.map((H,V)=>({time:H,energy:s.energies[V]})),_=s.timestamps.map((H,V)=>({time:H,onBeat:s.onBeatFlags[V]})),M=[];s.maxCombo>=50&&M.push({name:"Combo King",description:`${s.maxCombo}x combo streak!`}),l>=85&&M.push({name:"On-Beat Bandit",description:"Perfect rhythm!"}),(s.energies.length>0?1-h(s.energies)/(I(s.energies)+.001):0)>=.9&&M.push({name:"Mic Melter",description:"Sustained energy!"}),(s.pitchSamples.length>0?1-h(s.pitchSamples)/(I(s.pitchSamples)+.001):0)>=.9&&r>=80&&M.push({name:"Smooth Operator",description:"Consistent pitch!"});const te=[],q=10,ce=Math.max(...s.timestamps);for(let H=0;H<ce;H+=q){const V=Math.min(H+q,ce),re=s.timestamps.map((J,ne)=>J>=H&&J<V?ne:-1).filter(J=>J>=0);if(re.length>0){const J=I(re.map(Z=>s.pitchSamples[Z]))*100,ne=I(re.map(Z=>s.rhythmSamples[Z]))*100,le=I(re.map(Z=>s.energySamples[Z]))*100,me=J*m.PITCH_WEIGHT+ne*m.RHYTHM_WEIGHT+le*m.ENERGY_WEIGHT;te.push({phrase:Math.floor(H/q),start:H,end:V,pitchScore:J,rhythmScore:ne,energyScore:le,totalScore:me})}}return{totals:{total:j,pitch:r,rhythm:l,energy:c,motion:0},badges:M,graphs:{pitchTimeline:C,energyGraph:T,rhythmHeatmap:_},perPhrase:te,performance_data:s}},[]);return a.useEffect(()=>{if(P.current&&!N&&v.current.timestamps.length>0){console.log("ðŸŽ¤ Session ended, computing final results...");const s=k();s&&u&&(console.log("ðŸŽ¤ Final results:",s),u(s))}P.current=N},[N,k,u]),a.useEffect(()=>(S.current?(console.log("ðŸŽ¤ Session active, initializing audio processing..."),P.current||(console.log("ðŸŽ¤ Resetting performance data for new session"),v.current={pitchSamples:[],rhythmSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,frequencies:[],energies:[],onBeatFlags:[]},b.current={detectedOffset:0,confidence:0,samples:[]}),x.current?(console.log("ðŸŽ¤ Audio context already exists, ensuring processing is active"),o.current?console.log("ðŸŽ¤ AudioWorklet is active"):(console.log("ðŸŽ¤ AudioWorklet not active, reinitializing..."),L())):L()):(console.log("ðŸŽ¤ Session inactive, stopping audio processing"),g.current&&(g.current.getTracks().forEach(s=>s.stop()),g.current=null),x.current&&x.current.state!=="closed"&&(x.current.close().catch(()=>{}),x.current=null),o.current=null),()=>{g.current&&g.current.getTracks().forEach(s=>s.stop()),x.current&&x.current.state!=="closed"&&x.current.close().catch(()=>{})}),[N,L]),e.jsxs("div",{className:"live-hud",children:[e.jsx("canvas",{ref:y,width:1200,height:600,className:"hud-canvas"}),b.current.confidence>.5&&e.jsxs("div",{className:"key-shift-indicator",children:["Key shifted: ",b.current.detectedOffset>0?"+":"",b.current.detectedOffset.toFixed(0)," cents"]})]})};function Ce({onComplete:i}){const[p,N]=a.useState(null),[u,y]=a.useState(0),[x,o]=a.useState(!1),g=a.useRef(null),S=a.useRef(null),R=a.useRef(null);a.useRef(null);const O=a.useRef(null);a.useEffect(()=>()=>{O.current&&cancelAnimationFrame(O.current),R.current&&R.current.getTracks().forEach(n=>n.stop())},[]);const d=async()=>{try{const n=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});R.current=n,N(!0),E(n)}catch(n){console.error("Microphone access denied:",n),N(!1)}},E=n=>{try{console.log("Setting up audio analysis with stream:",n),g.current=new(window.AudioContext||window.webkitAudioContext),g.current.state==="suspended"&&g.current.resume().catch(()=>{}),S.current=g.current.createAnalyser(),g.current.createMediaStreamSource(n).connect(S.current),S.current.fftSize=256,S.current.smoothingTimeConstant=.8,console.log("Audio analyser configured:",{fftSize:S.current.fftSize,frequencyBinCount:S.current.frequencyBinCount,sampleRate:g.current.sampleRate}),v()}catch(f){console.error("Audio analysis setup failed:",f)}},v=()=>{const n=new Uint8Array(S.current.frequencyBinCount),f=new Uint8Array(S.current.fftSize),A=()=>{if(S.current){S.current.getByteFrequencyData(n),S.current.getByteTimeDomainData(f);let G=0;for(let F=0;F<n.length;F++)G+=n[F]*n[F];const $=Math.sqrt(G/Math.max(1,n.length));let Y=0;for(let F=0;F<f.length;F++){const z=f[F]-128;Y+=z*z}const B=Math.sqrt(Y/Math.max(1,f.length)),W=Math.max($/2,B),K=Math.min(W/32,1),U=Math.max(K,.02);Math.random()<.01&&console.log("Audio level debug:",{rmsFreq:$,rmsTime:B,rms:W,normalizedLevel:K,displayLevel:U}),y(U),O.current=requestAnimationFrame(A)}};A()},b=()=>{o(!0)},P=()=>{o(!1)},m=()=>{i()},L=()=>u<.1?"#ff3d00":u<.3?"#ffd700":u<.7?"#39ff14":"#ff00e6",t=()=>u<.1?"TOO QUIET":u<.3?"GETTING THERE":u<.7?"PERFECT":"TOO LOUD";return e.jsxs("div",{className:"mic-check-container",children:[e.jsxs("div",{className:"mic-check-header",children:[e.jsx("h2",{className:"neon-text",children:"ðŸŽ¤ MIC CHECK ðŸŽ¤"}),e.jsx("p",{children:"Let's make sure everything is working perfectly!"})]}),e.jsxs("div",{className:"mic-check-content",children:[e.jsxs("div",{className:"mic-section",children:[e.jsx("h3",{children:"Microphone"}),p===null&&e.jsx("button",{className:"retro-button large",onClick:d,children:"ðŸŽ¤ ENABLE MICROPHONE"}),p===!1&&e.jsxs("div",{className:"permission-denied",children:[e.jsx("p",{children:"âŒ Microphone access denied"}),e.jsx("p",{children:"Please allow microphone access to continue"}),e.jsx("button",{className:"retro-button",onClick:d,children:"TRY AGAIN"})]}),p===!0&&e.jsxs("div",{className:"mic-status",children:[e.jsx("div",{className:"audio-level-display",children:e.jsx("div",{className:"audio-level-bar",style:{height:`${u*100}%`,backgroundColor:L()}})}),e.jsxs("div",{className:"audio-level-info",children:[e.jsx("p",{className:`level-text ${t().replace(" ","-").toLowerCase()}`,children:t()}),e.jsxs("p",{className:"level-value",children:[(u*100).toFixed(0),"%"]})]}),e.jsx("div",{className:"mic-controls",children:x?e.jsx("button",{className:"retro-button",onClick:P,children:"â¹ï¸ STOP LISTENING"}):e.jsx("button",{className:"retro-button",onClick:b,children:"ðŸŽµ START LISTENING"})})]})]}),e.jsxs("div",{className:"instructions",children:[e.jsx("h4",{children:"Instructions:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"ðŸŽ¤ Enable microphone and test your audio levels"}),e.jsx("li",{children:"ðŸ“¹ Optionally enable motion tracking for bonus points"}),e.jsx("li",{children:"ðŸŽµ Sing a few notes to test your setup"}),e.jsx("li",{children:"âœ¨ When ready, proceed to the live performance!"})]})]}),p===!0&&e.jsxs("div",{className:"proceed-section",children:[e.jsx("button",{className:"retro-button large proceed",onClick:m,disabled:u<.02,children:"ðŸš€ START PERFORMANCE"}),u<.02&&e.jsx("p",{className:"warning",children:"âš ï¸ Please test your microphone first"})]})]})]})}function Te({apiBase:i,onBack:p,onNewSession:N}){const[u,y]=a.useState([]),[x,o]=a.useState(!0);a.useEffect(()=>{g()},[]);const g=async()=>{try{const E=await(await fetch(`${i}/leaderboard?limit=20`)).json();y(E)}catch(d){console.error("Failed to load leaderboard:",d)}finally{o(!1)}},S=d=>d===1?"ðŸ¥‡":d===2?"ðŸ¥ˆ":d===3?"ðŸ¥‰":`#${d}`,R=d=>d>=90?"#39ff14":d>=80?"#ffd700":d>=70?"#ff9500":"#ff3d00",O=d=>{const E=new Date(d);return E.toLocaleDateString()+" "+E.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})};return x?e.jsx("div",{className:"leaderboard-container",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("h2",{children:"LOADING LEADERBOARD..."})]})}):e.jsxs("div",{className:"leaderboard-container",children:[e.jsxs("div",{className:"leaderboard-header",children:[e.jsx("h1",{className:"neon-title",children:"ðŸ† LEADERBOARD ðŸ†"}),e.jsx("p",{className:"leaderboard-subtitle",children:"Top performers in the arcade!"})]}),e.jsx("div",{className:"leaderboard-content",children:u.length===0?e.jsxs("div",{className:"empty-leaderboard",children:[e.jsx("h2",{children:"ðŸŽ¤ NO SCORES YET"}),e.jsx("p",{children:"Be the first to submit a score!"}),e.jsx("button",{className:"retro-button large",onClick:N,children:"START SINGING"})]}):e.jsx("div",{className:"leaderboard-list",children:u.map((d,E)=>e.jsxs("div",{className:`leaderboard-entry ${E<3?"top-three":""}`,children:[e.jsx("div",{className:"rank",children:e.jsx("span",{className:"rank-icon",children:S(E+1)})}),e.jsxs("div",{className:"player-info",children:[e.jsx("h3",{className:"player-name",children:d.player_name}),e.jsx("p",{className:"play-date",children:O(d.played_at)})]}),e.jsxs("div",{className:"score-info",children:[e.jsx("div",{className:"total-score",style:{color:R(d.total_score)},children:Math.round(d.total_score)}),e.jsxs("div",{className:"score-breakdown",children:[e.jsxs("span",{children:["P: ",Math.round(d.pitch_score)]}),e.jsxs("span",{children:["R: ",Math.round(d.rhythm_score)]}),e.jsxs("span",{children:["E: ",Math.round(d.energy_score)]})]})]}),e.jsx("div",{className:"badges",children:d.badges&&d.badges.length>0&&e.jsx("div",{className:"badge-list",children:d.badges.map((v,b)=>e.jsxs("span",{className:"badge-mini",children:[v.name==="Combo King"&&"ðŸ‘‘",v.name==="On-Beat Bandit"&&"ðŸ¥",v.name==="Mic Melter"&&"ðŸ”¥",v.name==="Smooth Operator"&&"ðŸŽµ"]},b))})})]},d.id))})}),e.jsxs("div",{className:"leaderboard-actions",children:[e.jsx("button",{className:"retro-button",onClick:p,children:"â† BACK TO RESULTS"}),e.jsx("button",{className:"retro-button",onClick:N,children:"ðŸŽµ NEW SONG"}),e.jsx("button",{className:"retro-button",onClick:g,children:"ðŸ”„ REFRESH"})]}),e.jsxs("div",{className:"leaderboard-stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"TOTAL PLAYERS"}),e.jsx("span",{className:"stat-value",children:u.length})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"HIGHEST SCORE"}),e.jsx("span",{className:"stat-value",children:u.length>0?Math.round(u[0].total_score):0})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"AVERAGE SCORE"}),e.jsx("span",{className:"stat-value",children:u.length>0?Math.round(u.reduce((d,E)=>d+E.total_score,0)/u.length):0})]})]})]})}function Re({sessionId:i,results:p,apiBase:N,onNewSession:u,playerName:y,onPlayerNameChange:x}){const[o,g]=a.useState(p||null),[S,R]=a.useState(!p&&!!i),[O,d]=a.useState(!1),[E,v]=a.useState(!1);a.useEffect(()=>{p?(g(p),R(!1)):i&&b()},[i,p]);const b=async()=>{try{const n=await(await fetch(`${N}/sessions/${i}/results`)).json();g(n.results||n)}catch(t){console.error("Failed to load results:",t)}finally{R(!1)}},P=async()=>{if(!y.trim()){alert("Please enter your name!");return}try{(await fetch(`${N}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:i,player_name:y,scores:o.totals,badges:o.badges})})).ok&&(v(!0),d(!0))}catch(t){console.error("Failed to submit to leaderboard:",t),alert("Failed to submit to leaderboard")}},m=t=>t>=90?"#39ff14":t>=70?"#ffd700":t>=50?"#ff9500":"#ff3d00",L=t=>t>=95?"S+":t>=90?"S":t>=85?"A+":t>=80?"A":t>=75?"B+":t>=70?"B":t>=65?"C+":t>=60?"C":t>=50?"D":"F";return S?e.jsx("div",{className:"results-container",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("h2",{children:"CALCULATING RESULTS..."})]})}):o?e.jsx("div",{className:"results-container",children:O?e.jsx(Te,{apiBase:N,onBack:()=>d(!1),onNewSession:u}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"results-header",children:[e.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ PERFORMANCE COMPLETE! ðŸŽ¤"}),e.jsxs("div",{className:"final-score",children:[e.jsx("span",{className:"score-label",children:"FINAL SCORE"}),e.jsx("span",{className:"score-value",style:{color:m(o.totals.total)},children:Math.round(o.totals.total)}),e.jsx("span",{className:"score-grade",style:{color:m(o.totals.total)},children:L(o.totals.total)})]})]}),e.jsxs("div",{className:"score-breakdown",children:[e.jsx("h2",{children:"SCORE BREAKDOWN"}),e.jsxs("div",{className:"score-grid",children:[e.jsxs("div",{className:"score-item",children:[e.jsx("span",{className:"score-label",children:"PITCH"}),e.jsx("div",{className:"score-bar",children:e.jsx("div",{className:"score-fill pitch",style:{width:`${o.totals.pitch}%`}})}),e.jsx("span",{className:"score-value",children:Math.round(o.totals.pitch)})]}),e.jsxs("div",{className:"score-item",children:[e.jsx("span",{className:"score-label",children:"RHYTHM"}),e.jsx("div",{className:"score-bar",children:e.jsx("div",{className:"score-fill rhythm",style:{width:`${o.totals.rhythm}%`}})}),e.jsx("span",{className:"score-value",children:Math.round(o.totals.rhythm)})]}),e.jsxs("div",{className:"score-item",children:[e.jsx("span",{className:"score-label",children:"ENERGY"}),e.jsx("div",{className:"score-bar",children:e.jsx("div",{className:"score-fill energy",style:{width:`${o.totals.energy}%`}})}),e.jsx("span",{className:"score-value",children:Math.round(o.totals.energy)})]})]})]}),o.badges&&o.badges.length>0&&e.jsxs("div",{className:"badges-section",children:[e.jsx("h2",{children:"ðŸ† BADGES EARNED ðŸ†"}),e.jsx("div",{className:"badges-grid",children:o.badges.map((t,n)=>e.jsxs("div",{className:"badge",children:[e.jsxs("div",{className:"badge-icon",children:[t.name==="Combo King"&&"ðŸ‘‘",t.name==="On-Beat Bandit"&&"ðŸ¥",t.name==="Mic Melter"&&"ðŸ”¥",t.name==="Smooth Operator"&&"ðŸŽµ"]}),e.jsxs("div",{className:"badge-info",children:[e.jsx("h3",{children:t.name}),e.jsx("p",{children:t.description})]})]},n))})]}),o.graphs&&e.jsxs("div",{className:"charts-section",children:[e.jsx("h2",{children:"ðŸ“Š PERFORMANCE ANALYSIS"}),e.jsxs("div",{className:"chart-container",children:[e.jsx("h3",{children:"Pitch Timeline"}),e.jsx("div",{className:"chart",children:e.jsx("svg",{width:"100%",height:"200",className:"pitch-chart",children:o.graphs.pitchTimeline.map((t,n)=>{const f=Math.max(...o.graphs.pitchTimeline.map($=>$.time||0))||1,A=(t.time||0)/f*100,G=100-(t.score||0)/100*80;return e.jsx("circle",{cx:`${A}%`,cy:`${G}%`,r:"2",fill:"#39ff14",opacity:"0.7"},n)})})})]}),e.jsxs("div",{className:"chart-container",children:[e.jsx("h3",{children:"Energy Graph"}),e.jsx("div",{className:"chart",children:e.jsx("svg",{width:"100%",height:"200",className:"energy-chart",children:e.jsx("polyline",{points:(()=>{const t=Math.max(...o.graphs.energyGraph.map(n=>n.time||0))||1;return o.graphs.energyGraph.map(n=>`${(n.time||0)/t*100}%,${100-(n.energy||0)*100}%`).join(" ")})(),fill:"none",stroke:"#ff00e6",strokeWidth:"2"})})})]}),e.jsxs("div",{className:"chart-container",children:[e.jsx("h3",{children:"Rhythm Heatmap"}),e.jsx("div",{className:"chart",children:e.jsx("svg",{width:"100%",height:"200",className:"rhythm-chart",children:o.graphs.rhythmHeatmap.map((t,n)=>{const f=Math.max(...o.graphs.rhythmHeatmap.map(G=>G.time||0))||1,A=(t.time||0)/f*100;return e.jsx("rect",{x:`${A}%`,y:"50%",width:"1%",height:"50%",fill:t.onBeat?"#00e5ff":"#ff3d00",opacity:"0.8"},n)})})})]})]}),o.perPhrase&&o.perPhrase.length>0&&e.jsxs("div",{className:"phrases-section",children:[e.jsx("h2",{children:"ðŸŽµ PHRASE BREAKDOWN"}),e.jsx("div",{className:"phrases-grid",children:o.perPhrase.map((t,n)=>e.jsxs("div",{className:"phrase-item",children:[e.jsxs("div",{className:"phrase-header",children:[e.jsxs("span",{className:"phrase-number",children:["Phrase ",t.phrase+1]}),e.jsxs("span",{className:"phrase-time",children:[t.start.toFixed(1),"s - ",t.end.toFixed(1),"s"]})]}),e.jsxs("div",{className:"phrase-scores",children:[e.jsxs("span",{children:["Pitch: ",Math.round(t.pitchScore)]}),e.jsxs("span",{children:["Rhythm: ",Math.round(t.rhythmScore)]}),e.jsxs("span",{children:["Energy: ",Math.round(t.energyScore)]})]}),e.jsxs("div",{className:"phrase-total",children:["Total: ",Math.round(t.totalScore)]})]},n))})]}),!E&&e.jsxs("div",{className:"leaderboard-submission",children:[e.jsx("h2",{children:"ðŸ† SUBMIT TO LEADERBOARD"}),e.jsxs("div",{className:"submission-form",children:[e.jsx("input",{type:"text",placeholder:"Enter your name",value:y,onChange:t=>x(t.target.value),className:"name-input",maxLength:20}),e.jsx("button",{className:"retro-button large",onClick:P,disabled:!y.trim(),children:"SUBMIT SCORE"})]})]}),e.jsxs("div",{className:"results-actions",children:[e.jsx("button",{className:"retro-button",onClick:u,children:"ðŸŽµ NEW SONG"}),e.jsx("button",{className:"retro-button",onClick:()=>d(!0),children:"ðŸ“Š LEADERBOARD"})]})]})}):e.jsx("div",{className:"results-container",children:e.jsxs("div",{className:"error",children:[e.jsx("h2",{children:"âŒ RESULTS NOT FOUND"}),e.jsx("button",{className:"retro-button",onClick:u,children:"START NEW SESSION"})]})})}const Q="http://localhost:8080";function _e(){const[i,p]=a.useState("library"),[N,u]=a.useState(null),[y,x]=a.useState(null),[o,g]=a.useState(""),[S,R]=a.useState(0),[O,d]=a.useState(!1),[E,v]=a.useState(null),b=n=>{u(n),p("mic-check")},P=()=>{p("karaoke")},m=async n=>{try{y?(await fetch(`${Q}/sessions/${y}/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).catch(f=>console.warn("Failed to save results to backend:",f)),o&&await fetch(`${Q}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:y,player_name:o,scores:n.totals,badges:n.badges})}).catch(f=>console.warn("Failed to submit to leaderboard:",f))):console.warn("No session ID, results not saved to backend"),v(n),p("results")}catch(f){console.error("Error in handleSessionComplete:",f),v(n),p("results")}},L=()=>{p("library"),u(null),x(null),g(""),d(!1),v(null)},t=()=>{switch(i){case"library":return e.jsx(Se,{onSongSelect:b,apiBase:Q});case"mic-check":return e.jsx(Ce,{onComplete:P,wsUrl:`ws://localhost:8080/session/${y}`});case"karaoke":return e.jsxs("div",{className:"karaoke-stage",children:[e.jsx(Ee,{songData:N,apiBase:Q,onSessionComplete:m,onStartSession:async()=>{try{const n=await fetch(`${Q}/sessions/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({song_id:N.id})});if(!n.ok){const A=await n.json();throw console.error("Failed to start session:",A),new Error(A.error||"Failed to start session")}const f=await n.json();x(f.session_id)}catch(n){console.error("Error starting session:",n),alert(`Failed to start session: ${n.message}`),d(!1)}},onTimeUpdate:n=>R(n),isSessionActive:O,onSessionToggle:n=>d(n)}),e.jsx(be,{referenceData:N==null?void 0:N.reference_data,externalTime:S,isSessionActive:O,onSessionComplete:m})]});case"results":return e.jsx(Re,{sessionId:y,results:E,apiBase:Q,onNewSession:L,playerName:o,onPlayerNameChange:g});default:return e.jsx("div",{children:"Unknown screen"})}};return e.jsxs("div",{className:"app",children:[e.jsxs("header",{className:"app-header",children:[e.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ KARAOKE ARCADE ðŸŽ¤"}),e.jsx("div",{className:"status-indicators"})]}),e.jsx("main",{className:"app-main",children:t()}),e.jsx("footer",{className:"app-footer",children:e.jsxs("div",{className:"controls",children:[e.jsx("button",{className:"retro-button",onClick:L,disabled:i==="library",children:"ðŸŽµ SONG LIBRARY"}),e.jsx("button",{className:"retro-button",onClick:()=>p("results"),disabled:!y,children:"ðŸ“Š LEADERBOARD"})]})})]})}const de=document.querySelector(".loading-screen");de&&(de.style.display="none");oe.createRoot(document.getElementById("root")).render(e.jsx(pe.StrictMode,{children:e.jsx(_e,{})}));
